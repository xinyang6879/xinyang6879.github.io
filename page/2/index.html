<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yangxin">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-源码/【源码】axios-流程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91axios-%E6%B5%81%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:33.944Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/axios-%E6%BA%90%E7%A0%81/">axios 源码</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91axios-%E6%B5%81%E7%A8%8B/">axios请求流程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h2><p>axios的入口是<code>/lib/axios.js</code>，实际主要的流程在<code>/lib/core/Axios.js</code>中</p>
<p>在<code>/lib/axios.js</code>中，创建了一个<code>/lib/core/Axios.js</code>实例，并继承了其父类的方法，其中就包括<code>get</code>&#x2F;<code>post</code>&#x2F;<code>delete</code>等方法</p>
<p><code>axios</code>实际是从<code>request</code>方法发起全部请求的，只是封装了<code>get</code>&#x2F;<code>post</code>&#x2F;<code>delete</code>等方法，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/core/Axios.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Axios</span>(<span class="params">instanceConfig</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">defaults</span> = instanceConfig;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interceptors</span> = &#123;</span><br><span class="line">    <span class="attr">request</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>(),</span><br><span class="line">    <span class="attr">response</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>()</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /lib/axios.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Axios</span> = <span class="built_in">require</span>(<span class="string">&#x27;./core/Axios&#x27;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createInstance</span>(<span class="params">defaultConfig</span>) &#123;</span><br><span class="line">  <span class="comment">// context的prototype上已经包含了get等方法</span></span><br><span class="line">  <span class="keyword">var</span> context = <span class="keyword">new</span> <span class="title class_">Axios</span>(defaultConfig);</span><br><span class="line">  <span class="comment">// 直接调用instance时，实际就是调用了request方法</span></span><br><span class="line">  <span class="comment">// 这就是为什么在调用axios时，除了可以通过get/post进行请求，也可以直接作为一个函数进行直接调用</span></span><br><span class="line">  <span class="keyword">var</span> instance = <span class="title function_">bind</span>(<span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">request</span>, context);</span><br><span class="line"></span><br><span class="line">  utils.<span class="title function_">extend</span>(instance, <span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>, context);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Copy context to instance</span></span><br><span class="line">  utils.<span class="title function_">extend</span>(instance, context);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Factory for creating new instances</span></span><br><span class="line">  instance.<span class="property">create</span> = <span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">instanceConfig</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createInstance</span>(<span class="title function_">mergeConfig</span>(defaultConfig, instanceConfig));</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="请求流程"><a href="#请求流程" class="headerlink" title="请求流程"></a>请求流程</h2><p>主要的请求流程都在<code>request</code>方法里，方法存在于<code>/lib/core/Axios.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/core/Axios.js</span></span><br><span class="line"><span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">request</span> = <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">configOrUrl, config</span>) &#123;</span><br><span class="line">  <span class="comment">// 适配无额外配置，直接传入url的情况</span></span><br><span class="line">  <span class="comment">// 比如 axios(&#x27;example/url&#x27;)</span></span><br><span class="line">  <span class="comment">// Allow for axios(&#x27;example/url&#x27;[, config]) a la fetch API</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> configOrUrl === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    config = config || &#123;&#125;;</span><br><span class="line">    config.<span class="property">url</span> = configOrUrl;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    config = configOrUrl || &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将默认配置和传入的配置合并</span></span><br><span class="line">  config = <span class="title function_">mergeConfig</span>(<span class="variable language_">this</span>.<span class="property">defaults</span>, config);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置请求方法</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">method</span>) &#123;</span><br><span class="line">    config.<span class="property">method</span> = config.<span class="property">method</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">defaults</span>.<span class="property">method</span>) &#123;</span><br><span class="line">    config.<span class="property">method</span> = <span class="variable language_">this</span>.<span class="property">defaults</span>.<span class="property">method</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    config.<span class="property">method</span> = <span class="string">&#x27;get&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> transitional = config.<span class="property">transitional</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (transitional !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    validator.<span class="title function_">assertOptions</span>(transitional, &#123;</span><br><span class="line">      <span class="comment">// 版本兼容配置-返回值转换为 Json 出错时是否置为 null 返回</span></span><br><span class="line">      <span class="attr">silentJSONParsing</span>: validators.<span class="title function_">transitional</span>(validators.<span class="property">boolean</span>),</span><br><span class="line">      <span class="comment">// 版本兼容配置-responseType 设置非 json 类型时是否强制转换成 json 格式</span></span><br><span class="line">      <span class="attr">forcedJSONParsing</span>: validators.<span class="title function_">transitional</span>(validators.<span class="property">boolean</span>),</span><br><span class="line">      <span class="comment">// 版本兼容配置-请求超时时是否默认返回 ETIMEDOUT 类型错</span></span><br><span class="line">      <span class="attr">clarifyTimeoutError</span>: validators.<span class="title function_">transitional</span>(validators.<span class="property">boolean</span>)</span><br><span class="line">    &#125;, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// filter out skipped interceptors</span></span><br><span class="line">  <span class="comment">// 请求拦截器数组</span></span><br><span class="line">  <span class="keyword">var</span> requestInterceptorChain = [];</span><br><span class="line">  <span class="keyword">var</span> synchronousRequestInterceptors = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// 循环访问拦截器的请求数组，将其放在请求真实执行之前</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">unshiftRequestInterceptors</span>(<span class="params">interceptor</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> interceptor.<span class="property">runWhen</span> === <span class="string">&#x27;function&#x27;</span> &amp;&amp; interceptor.<span class="title function_">runWhen</span>(config) === <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synchronousRequestInterceptors = synchronousRequestInterceptors &amp;&amp; interceptor.<span class="property">synchronous</span>;</span><br><span class="line"></span><br><span class="line">    requestInterceptorChain.<span class="title function_">unshift</span>(interceptor.<span class="property">fulfilled</span>, interceptor.<span class="property">rejected</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 响应拦截器数组</span></span><br><span class="line">  <span class="comment">// 循环访问拦截器的响应数组，将其放在请求真实执行之后</span></span><br><span class="line">  <span class="keyword">var</span> responseInterceptorChain = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">pushResponseInterceptors</span>(<span class="params">interceptor</span>) &#123;</span><br><span class="line">    responseInterceptorChain.<span class="title function_">push</span>(interceptor.<span class="property">fulfilled</span>, interceptor.<span class="property">rejected</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> promise;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!synchronousRequestInterceptors) &#123;</span><br><span class="line">    <span class="keyword">var</span> chain = [dispatchRequest, <span class="literal">undefined</span>];</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">unshift</span>.<span class="title function_">apply</span>(chain, requestInterceptorChain);</span><br><span class="line">    chain = chain.<span class="title function_">concat</span>(responseInterceptorChain);</span><br><span class="line"></span><br><span class="line">    promise = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(config);</span><br><span class="line">    <span class="keyword">while</span> (chain.<span class="property">length</span>) &#123;</span><br><span class="line">      promise = promise.<span class="title function_">then</span>(chain.<span class="title function_">shift</span>(), chain.<span class="title function_">shift</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> newConfig = config;</span><br><span class="line">  <span class="comment">// 一步步执行请求拦截器，并将其执行结果覆盖请求配置</span></span><br><span class="line">  <span class="keyword">while</span> (requestInterceptorChain.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> onFulfilled = requestInterceptorChain.<span class="title function_">shift</span>();</span><br><span class="line">    <span class="keyword">var</span> onRejected = requestInterceptorChain.<span class="title function_">shift</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      newConfig = <span class="title function_">onFulfilled</span>(newConfig);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="title function_">onRejected</span>(error);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行请求</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    promise = <span class="title function_">dispatchRequest</span>(newConfig);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 一步步执行响应拦截器</span></span><br><span class="line">  <span class="keyword">while</span> (responseInterceptorChain.<span class="property">length</span>) &#123;</span><br><span class="line">    promise = promise.<span class="title function_">then</span>(responseInterceptorChain.<span class="title function_">shift</span>(), responseInterceptorChain.<span class="title function_">shift</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里包含的流程如下：</p>
<ul>
<li>合并配置，包括默认配置和传入的配置</li>
<li>设置请求方法</li>
<li>请求拦截器 requestInterceptorChain</li>
<li>响应拦截器 responseInterceptorChain</li>
<li>执行请求（dispatchRequest），且是在请求拦截器之后，响应拦截器之前</li>
</ul>
<p>注意点：</p>
<ul>
<li>这里的执行是放在一个数组里面的，最开始只有实际的请求，然后在数组开头加上请求的拦截器函数，在数组最后加上请求的响应拦截器处理函数</li>
<li>拦截器的函数的参数是从上一个拦截器中返回的结果</li>
<li>默认请求头是<code>get</code></li>
</ul>
<h2 id="派发请求"><a href="#派发请求" class="headerlink" title="派发请求"></a>派发请求</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/core/dispatchRequest.js</span></span><br><span class="line"><span class="comment">// 派发请求</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> <span class="title function_">dispatchRequest</span>(<span class="params">config</span>) &#123;</span><br><span class="line">  <span class="comment">// 取消请求相关</span></span><br><span class="line">  <span class="title function_">throwIfCancellationRequested</span>(config);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ensure headers exist</span></span><br><span class="line">  config.<span class="property">headers</span> = config.<span class="property">headers</span> || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Transform the data for a request or a response</span></span><br><span class="line">  config.<span class="property">data</span> = transformData.<span class="title function_">call</span>(</span><br><span class="line">    config,</span><br><span class="line">    config.<span class="property">data</span>,<span class="comment">//方法参数，如果是多个方法，那么方法2的参数是由方法1的返回值决定的</span></span><br><span class="line">    config.<span class="property">headers</span>,<span class="comment">//请求头</span></span><br><span class="line">    config.<span class="property">transformRequest</span><span class="comment">//执行的方法，具体是在axios里面自己定义了，在/lib/defaults.js文件中，主要是用于请求头的修改</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 合并拉平请求头</span></span><br><span class="line">  config.<span class="property">headers</span> = utils.<span class="title function_">merge</span>(</span><br><span class="line">    config.<span class="property">headers</span>.<span class="property">common</span> || &#123;&#125;,</span><br><span class="line">    config.<span class="property">headers</span>[config.<span class="property">method</span>] || &#123;&#125;,</span><br><span class="line">    config.<span class="property">headers</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是这些请求，那么就删除掉对应的请求头</span></span><br><span class="line">  utils.<span class="title function_">forEach</span>(</span><br><span class="line">    [<span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;head&#x27;</span>, <span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;put&#x27;</span>, <span class="string">&#x27;patch&#x27;</span>, <span class="string">&#x27;common&#x27;</span>],</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">cleanHeaderConfig</span>(<span class="params">method</span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> config.<span class="property">headers</span>[method];</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> adapter = config.<span class="property">adapter</span> || defaults.<span class="property">adapter</span>;</span><br><span class="line">  <span class="comment">// 执行适配器</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">adapter</span>(config).<span class="title function_">then</span>(<span class="keyword">function</span> <span class="title function_">onAdapterResolution</span>(<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="comment">// 取消相关请求的</span></span><br><span class="line">    <span class="title function_">throwIfCancellationRequested</span>(config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transform response data</span></span><br><span class="line">    response.<span class="property">data</span> = transformData.<span class="title function_">call</span>(</span><br><span class="line">      config,</span><br><span class="line">      response.<span class="property">data</span>,</span><br><span class="line">      response.<span class="property">headers</span>,</span><br><span class="line">      config.<span class="property">transformResponse</span><span class="comment">//执行的方法，具体是在axios里面自己定义了，在/lib/defaults.js文件中，主要是用于响应结果的修改</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;, <span class="keyword">function</span> <span class="title function_">onAdapterRejection</span>(<span class="params">reason</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isCancel</span>(reason)) &#123;</span><br><span class="line">      <span class="title function_">throwIfCancellationRequested</span>(config);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Transform response data</span></span><br><span class="line">      <span class="keyword">if</span> (reason &amp;&amp; reason.<span class="property">response</span>) &#123;</span><br><span class="line">        reason.<span class="property">response</span>.<span class="property">data</span> = transformData.<span class="title function_">call</span>(</span><br><span class="line">          config,</span><br><span class="line">          reason.<span class="property">response</span>.<span class="property">data</span>,</span><br><span class="line">          reason.<span class="property">response</span>.<span class="property">headers</span>,</span><br><span class="line">          config.<span class="property">transformResponse</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(reason);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>流程：</p>
<ul>
<li>统一处理请求头</li>
<li>合并拉平请求头</li>
<li>某些请求会删除请求头的<code>config.headers[method]</code></li>
<li>执行请求</li>
<li>获取到响应数据后，统一处理响应结果</li>
</ul>
<p>注意点：</p>
<ul>
<li><code>[&#39;delete&#39;, &#39;get&#39;, &#39;head&#39;, &#39;post&#39;, &#39;put&#39;, &#39;patch&#39;, &#39;common&#39;]</code>这些请求axios会删除请求头的<code>config.headers[method]</code></li>
<li>关于请求头的统一额外处理，在这个阶段进行</li>
<li>关于响应结果的解析，是在这个阶段执行的</li>
</ul>
<h2 id="实际请求发送"><a href="#实际请求发送" class="headerlink" title="实际请求发送"></a>实际请求发送</h2><p>适配器解释了为什么axios可以在nodejs和浏览器里面都发送请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/defaults/index,js</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getDefaultAdapter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> adapter;</span><br><span class="line">  <span class="comment">// 如果是浏览器的环境，那么就用的是xhr</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">XMLHttpRequest</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// For browsers use XHR adapter</span></span><br><span class="line">    adapter = <span class="built_in">require</span>(<span class="string">&#x27;../adapters/xhr&#x27;</span>);</span><br><span class="line">  <span class="comment">// 如果是非浏览器的环境（例如nodejs），那么就用的是http的文件</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> process !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(process) === <span class="string">&#x27;[object process]&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// For node use HTTP adapter</span></span><br><span class="line">    adapter = <span class="built_in">require</span>(<span class="string">&#x27;../adapters/http&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> adapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/adapters/xhr.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> <span class="title function_">xhrAdapter</span>(<span class="params">config</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> <span class="title function_">dispatchXhrRequest</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">    <span class="comment">// 拿到请求配置项</span></span><br><span class="line">    <span class="keyword">var</span> requestData = config.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">var</span> requestHeaders = config.<span class="property">headers</span>;</span><br><span class="line">    <span class="keyword">var</span> responseType = config.<span class="property">responseType</span>;</span><br><span class="line">    <span class="keyword">var</span> onCanceled;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">done</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 如果有取消的，那么走取消请求</span></span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">cancelToken</span>) &#123;</span><br><span class="line">        config.<span class="property">cancelToken</span>.<span class="title function_">unsubscribe</span>(onCanceled);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">signal</span>) &#123;</span><br><span class="line">        config.<span class="property">signal</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;abort&#x27;</span>, onCanceled);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置form请求的请求头</span></span><br><span class="line">    <span class="keyword">if</span> (utils.<span class="title function_">isFormData</span>(requestData) &amp;&amp; utils.<span class="title function_">isStandardBrowserEnv</span>()) &#123;</span><br><span class="line">      <span class="keyword">delete</span> requestHeaders[<span class="string">&#x27;Content-Type&#x27;</span>]; <span class="comment">// Let the browser set it</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建xhr请求</span></span><br><span class="line">    <span class="keyword">var</span> request = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有设置授权相关的，那么配置其请求头</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">auth</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> username = config.<span class="property">auth</span>.<span class="property">username</span> || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="keyword">var</span> password = config.<span class="property">auth</span>.<span class="property">password</span> ? <span class="built_in">unescape</span>(<span class="built_in">encodeURIComponent</span>(config.<span class="property">auth</span>.<span class="property">password</span>)) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      requestHeaders.<span class="property">Authorization</span> = <span class="string">&#x27;Basic &#x27;</span> + <span class="title function_">btoa</span>(username + <span class="string">&#x27;:&#x27;</span> + password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fullPath = <span class="title function_">buildFullPath</span>(config.<span class="property">baseURL</span>, config.<span class="property">url</span>);</span><br><span class="line"></span><br><span class="line">    request.<span class="title function_">open</span>(config.<span class="property">method</span>.<span class="title function_">toUpperCase</span>(), <span class="title function_">buildURL</span>(fullPath, config.<span class="property">params</span>, config.<span class="property">paramsSerializer</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the request timeout in MS</span></span><br><span class="line">    request.<span class="property">timeout</span> = config.<span class="property">timeout</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">onloadend</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Prepare the response</span></span><br><span class="line">      <span class="keyword">var</span> responseHeaders = <span class="string">&#x27;getAllResponseHeaders&#x27;</span> <span class="keyword">in</span> request ? <span class="title function_">parseHeaders</span>(request.<span class="title function_">getAllResponseHeaders</span>()) : <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">var</span> responseData = !responseType || responseType === <span class="string">&#x27;text&#x27;</span> ||  responseType === <span class="string">&#x27;json&#x27;</span> ?</span><br><span class="line">        request.<span class="property">responseText</span> : request.<span class="property">response</span>;</span><br><span class="line">      <span class="keyword">var</span> response = &#123;</span><br><span class="line">        <span class="attr">data</span>: responseData,</span><br><span class="line">        <span class="attr">status</span>: request.<span class="property">status</span>,</span><br><span class="line">        <span class="attr">statusText</span>: request.<span class="property">statusText</span>,</span><br><span class="line">        <span class="attr">headers</span>: responseHeaders,</span><br><span class="line">        <span class="attr">config</span>: config,</span><br><span class="line">        <span class="attr">request</span>: request</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">settle</span>(<span class="keyword">function</span> <span class="title function_">_resolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(value);</span><br><span class="line">        <span class="title function_">done</span>();</span><br><span class="line">      &#125;, <span class="keyword">function</span> <span class="title function_">_reject</span>(<span class="params">err</span>) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(err);</span><br><span class="line">        <span class="title function_">done</span>();</span><br><span class="line">      &#125;, response);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Clean up request</span></span><br><span class="line">      request = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;onloadend&#x27;</span> <span class="keyword">in</span> request) &#123;</span><br><span class="line">      <span class="comment">// Use onloadend if available</span></span><br><span class="line">      request.<span class="property">onloadend</span> = onloadend;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Listen for ready state to emulate onloadend</span></span><br><span class="line">      request.<span class="property">onreadystatechange</span> = <span class="keyword">function</span> <span class="title function_">handleLoad</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!request || request.<span class="property">readyState</span> !== <span class="number">4</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The request errored out and we didn&#x27;t get a response, this will be</span></span><br><span class="line">        <span class="comment">// handled by onerror instead</span></span><br><span class="line">        <span class="comment">// With one exception: request that using file: protocol, most browsers</span></span><br><span class="line">        <span class="comment">// will return status as 0 even though it&#x27;s a successful request</span></span><br><span class="line">        <span class="keyword">if</span> (request.<span class="property">status</span> === <span class="number">0</span> &amp;&amp; !(request.<span class="property">responseURL</span> &amp;&amp; request.<span class="property">responseURL</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;file:&#x27;</span>) === <span class="number">0</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// readystate handler is calling before onerror or ontimeout handlers,</span></span><br><span class="line">        <span class="comment">// so we should call onloadend on the next &#x27;tick&#x27;</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(onloadend);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle browser request cancellation (as opposed to a manual cancellation)</span></span><br><span class="line">    request.<span class="property">onabort</span> = <span class="keyword">function</span> <span class="title function_">handleAbort</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AxiosError</span>(<span class="string">&#x27;Request aborted&#x27;</span>, <span class="title class_">AxiosError</span>.<span class="property">ECONNABORTED</span>, config, request));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Clean up request</span></span><br><span class="line">      request = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle low level network errors</span></span><br><span class="line">    request.<span class="property">onerror</span> = <span class="keyword">function</span> <span class="title function_">handleError</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// Real errors are hidden from us by the browser</span></span><br><span class="line">      <span class="comment">// onerror should only fire if it&#x27;s a network error</span></span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AxiosError</span>(<span class="string">&#x27;Network Error&#x27;</span>, <span class="title class_">AxiosError</span>.<span class="property">ERR_NETWORK</span>, config, request, request));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Clean up request</span></span><br><span class="line">      request = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle timeout</span></span><br><span class="line">    request.<span class="property">ontimeout</span> = <span class="keyword">function</span> <span class="title function_">handleTimeout</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> timeoutErrorMessage = config.<span class="property">timeout</span> ? <span class="string">&#x27;timeout of &#x27;</span> + config.<span class="property">timeout</span> + <span class="string">&#x27;ms exceeded&#x27;</span> : <span class="string">&#x27;timeout exceeded&#x27;</span>;</span><br><span class="line">      <span class="keyword">var</span> transitional = config.<span class="property">transitional</span> || transitionalDefaults;</span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">timeoutErrorMessage</span>) &#123;</span><br><span class="line">        timeoutErrorMessage = config.<span class="property">timeoutErrorMessage</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AxiosError</span>(</span><br><span class="line">        timeoutErrorMessage,</span><br><span class="line">        transitional.<span class="property">clarifyTimeoutError</span> ? <span class="title class_">AxiosError</span>.<span class="property">ETIMEDOUT</span> : <span class="title class_">AxiosError</span>.<span class="property">ECONNABORTED</span>,</span><br><span class="line">        config,</span><br><span class="line">        request));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Clean up request</span></span><br><span class="line">      request = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add xsrf header</span></span><br><span class="line">    <span class="comment">// This is only done if running in a standard browser environment.</span></span><br><span class="line">    <span class="comment">// Specifically not if we&#x27;re in a web worker, or react-native.</span></span><br><span class="line">    <span class="keyword">if</span> (utils.<span class="title function_">isStandardBrowserEnv</span>()) &#123;</span><br><span class="line">      <span class="comment">// Add xsrf header</span></span><br><span class="line">      <span class="keyword">var</span> xsrfValue = (config.<span class="property">withCredentials</span> || <span class="title function_">isURLSameOrigin</span>(fullPath)) &amp;&amp; config.<span class="property">xsrfCookieName</span> ?</span><br><span class="line">        cookies.<span class="title function_">read</span>(config.<span class="property">xsrfCookieName</span>) :</span><br><span class="line">        <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (xsrfValue) &#123;</span><br><span class="line">        requestHeaders[config.<span class="property">xsrfHeaderName</span>] = xsrfValue;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add headers to the request</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;setRequestHeader&#x27;</span> <span class="keyword">in</span> request) &#123;</span><br><span class="line">      utils.<span class="title function_">forEach</span>(requestHeaders, <span class="keyword">function</span> <span class="title function_">setRequestHeader</span>(<span class="params">val, key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> requestData === <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; key.<span class="title function_">toLowerCase</span>() === <span class="string">&#x27;content-type&#x27;</span>) &#123;</span><br><span class="line">          <span class="comment">// Remove Content-Type if data is undefined</span></span><br><span class="line">          <span class="keyword">delete</span> requestHeaders[key];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Otherwise add header to the request</span></span><br><span class="line">          request.<span class="title function_">setRequestHeader</span>(key, val);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add withCredentials to request if needed</span></span><br><span class="line">    <span class="keyword">if</span> (!utils.<span class="title function_">isUndefined</span>(config.<span class="property">withCredentials</span>)) &#123;</span><br><span class="line">      request.<span class="property">withCredentials</span> = !!config.<span class="property">withCredentials</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add responseType to request if needed</span></span><br><span class="line">    <span class="keyword">if</span> (responseType &amp;&amp; responseType !== <span class="string">&#x27;json&#x27;</span>) &#123;</span><br><span class="line">      request.<span class="property">responseType</span> = config.<span class="property">responseType</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle progress if needed</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> config.<span class="property">onDownloadProgress</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      request.<span class="title function_">addEventListener</span>(<span class="string">&#x27;progress&#x27;</span>, config.<span class="property">onDownloadProgress</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Not all browsers support upload events</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> config.<span class="property">onUploadProgress</span> === <span class="string">&#x27;function&#x27;</span> &amp;&amp; request.<span class="property">upload</span>) &#123;</span><br><span class="line">      request.<span class="property">upload</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;progress&#x27;</span>, config.<span class="property">onUploadProgress</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 取消请求相关</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">cancelToken</span> || config.<span class="property">signal</span>) &#123;</span><br><span class="line">      <span class="comment">// Handle cancellation</span></span><br><span class="line">      <span class="comment">// eslint-disable-next-line func-names</span></span><br><span class="line">      onCanceled = <span class="keyword">function</span>(<span class="params">cancel</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">reject</span>(!cancel || (cancel &amp;&amp; cancel.<span class="property">type</span>) ? <span class="keyword">new</span> <span class="title class_">CanceledError</span>() : cancel);</span><br><span class="line">        request.<span class="title function_">abort</span>();</span><br><span class="line">        request = <span class="literal">null</span>;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      config.<span class="property">cancelToken</span> &amp;&amp; config.<span class="property">cancelToken</span>.<span class="title function_">subscribe</span>(onCanceled);</span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">signal</span>) &#123;</span><br><span class="line">        config.<span class="property">signal</span>.<span class="property">aborted</span> ? <span class="title function_">onCanceled</span>() : config.<span class="property">signal</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;abort&#x27;</span>, onCanceled);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!requestData) &#123;</span><br><span class="line">      requestData = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> protocol = <span class="title function_">parseProtocol</span>(fullPath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (protocol &amp;&amp; [ <span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;https&#x27;</span>, <span class="string">&#x27;file&#x27;</span> ].<span class="title function_">indexOf</span>(protocol) === -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AxiosError</span>(<span class="string">&#x27;Unsupported protocol &#x27;</span> + protocol + <span class="string">&#x27;:&#x27;</span>, <span class="title class_">AxiosError</span>.<span class="property">ERR_BAD_REQUEST</span>, config));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send the request</span></span><br><span class="line">    request.<span class="title function_">send</span>(requestData);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注意点：</p>
<ul>
<li><code>auth</code>是表示授权相关的请求头，axios会默认加上配置</li>
<li>如果是form表单请求，axios会删除<code>Content-Type</code>请求头</li>
<li>在这里也做了取消请求相关的，利用的是xhr的<code>abort</code>函数进行请求取消</li>
</ul>
<h2 id="参链"><a href="#参链" class="headerlink" title="参链"></a>参链</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&mid=2650744604&idx=1&sn=51d8d865c9848fd59f7763f5fb9ce789&chksm=88662490bf11ad86061ae76ff71a1177eeddab02c38d046eecd0e1ad25dc16f7591f91e9e3b2&scene=21#wechat_redirect">学习 axios 源码整体架构，打造属于自己的请求库</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.axios-js.com/zh-cn/docs/#axios-spread-callback">axios官网</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91axios-%E6%B5%81%E7%A8%8B/" data-id="cmf67fxem007wbcfm7ku95l2c" data-title="axios请求流程" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/axios-%E6%BA%90%E7%A0%81/" rel="tag">axios 源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-源码/【源码】vuex-初始化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91vuex-%E5%88%9D%E5%A7%8B%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:33.944Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/vuex-%E6%BA%90%E7%A0%81/">vuex 源码</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91vuex-%E5%88%9D%E5%A7%8B%E5%8C%96/">vuex-流程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>源码位置：<code>vuex/dist/vuex.esm.js</code>，该文件默认导出了<code>&#123; Store, createLogger, createNamespacedHelpers, install, mapActions, mapGetters, mapMutations, mapState &#125;</code>，在使用 vuex 时，用的<code>vue.use(Vuex)</code>实际执行的是<code>install</code>方法</p>
<h2 id="引入-vuex"><a href="#引入-vuex" class="headerlink" title="引入 vuex"></a>引入 vuex</h2><h3 id="install"><a href="#install" class="headerlink" title="install"></a>install</h3><ul>
<li>首先判断传入的 vue 是否和之前的 vue 一致，如果一致的话且非 prd 环境，则会抛出异常<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title class_">Vue</span> &amp;&amp; _Vue === <span class="title class_">Vue</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">      <span class="string">&quot;[vuex] already installed. Vue.use(Vuex) should be called only once.&quot;</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>将传入的 vue 赋值给 vuex 的全局变量<br>  用于判断是否已经装载和减少全局作用域查找<br><code>Vue = _Vue;</code></li>
<li>利用 vue3 以下的 mixin，将 vuex 挂载到 vm 的全局上</li>
</ul>
<h3 id="mixin"><a href="#mixin" class="headerlink" title="mixin"></a>mixin</h3><ul>
<li>首先判断 vue 的版本，如果是在 v2 以上，那么直接调用<code>mixin</code>方法<br><code> Vue.mixin(&#123; beforeCreate: vuexInit &#125;);</code></li>
<li>若非 vue2 以上，那么就调用 vue 的 init 方法。将初始化的函数加入 vue 的 init 方法列表中，并进行循环调用<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">options.<span class="property">init</span> = options.<span class="property">init</span> ? [vuexInit].<span class="title function_">concat</span>(options.<span class="property">init</span>) : vuexInit;</span><br><span class="line">_init.<span class="title function_">call</span>(<span class="variable language_">this</span>, options);</span><br></pre></td></tr></table></figure>
<ul>
<li>vuexInit 方法：判断当前 vue 是否是 root（用是否有 parent 进行判断）。若是 root，那么就将 store 赋值到 rootVue 的<code>$store</code>中，若不是，那么就将父 Vue 的<code>$store</code>作为当前 vue 的<code>$store</code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (options.<span class="property">store</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$store</span> =</span><br><span class="line">    <span class="keyword">typeof</span> options.<span class="property">store</span> === <span class="string">&quot;function&quot;</span> ? options.<span class="title function_">store</span>() : options.<span class="property">store</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.<span class="property">parent</span> &amp;&amp; options.<span class="property">parent</span>.<span class="property">$store</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$store</span> = options.<span class="property">parent</span>.<span class="property">$store</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="创建-store"><a href="#创建-store" class="headerlink" title="创建 store"></a>创建 store</h2><p>创建 store 时，执行的是<code>Store</code>方法</p>
<h3 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h3><ul>
<li><p>首先进行一堆初始值赋值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> plugins = options.<span class="property">plugins</span>;</span><br><span class="line"><span class="keyword">if</span> (plugins === <span class="keyword">void</span> <span class="number">0</span>) plugins = [];</span><br><span class="line"><span class="keyword">var</span> strict = options.<span class="property">strict</span>;</span><br><span class="line"><span class="keyword">if</span> (strict === <span class="keyword">void</span> <span class="number">0</span>) strict = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// store internal state</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_committing</span> = <span class="literal">false</span>; <span class="comment">//是否是修改state</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_actions</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_actionSubscribers</span> = [];</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_mutations</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_wrappedGetters</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_modules</span> = <span class="keyword">new</span> <span class="title class_">ModuleCollection</span>(options); <span class="comment">//初始化注册module</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_modulesNamespaceMap</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_subscribers</span> = [];</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_watcherVM</span> = <span class="keyword">new</span> <span class="title class_">Vue</span>(); <span class="comment">//用于store的watch使用</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_makeLocalGettersCache</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 dispatch 重新赋值执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ref = <span class="variable language_">this</span>;</span><br><span class="line"><span class="keyword">var</span> dispatch = ref.<span class="property">dispatch</span>;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">dispatch</span> = <span class="keyword">function</span> <span class="title function_">boundDispatch</span>(<span class="params">type, payload</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> dispatch.<span class="title function_">call</span>(store, type, payload);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里调用的还是 store 上面的 dispatch 方法</p>
</li>
<li><p>将 commit 重新赋值执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">commit</span> = <span class="keyword">function</span> <span class="title function_">boundCommit</span>(<span class="params">type, payload, options</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> commit.<span class="title function_">call</span>(store, type, payload, options);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>初始化 module（installModule）<br>这里的 state，是经过了<code>new ModuleCollection</code>流程的，取用的是 module 根节点的 state，实际就是项目中 store 的 module 配置列表</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> state = <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="property">root</span>.<span class="property">state</span>;</span><br><span class="line"><span class="title function_">installModule</span>(<span class="variable language_">this</span>, state, [], <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="property">root</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>对 store 的<code>_vm</code>重新赋值<br><code>resetStoreVM(this, state);</code></p>
</li>
<li><p>执行 plugins 列表</p>
</li>
</ul>
<h3 id="module-相关"><a href="#module-相关" class="headerlink" title="module 相关"></a>module 相关</h3><h4 id="new-ModuleCollection"><a href="#new-ModuleCollection" class="headerlink" title="new ModuleCollection"></a>new ModuleCollection</h4><p>创建了一个 module 的对象，store 里面的 module 并不是直接归属 store 下的一个对象，而是 ModuleCollection 函数，这个是一个独立的对象</p>
<p>而 ModuleCollection 又是由一个个 Module 对象集合而成的</p>
<p>ModuleCollection 有一个根节点，根节点创建完成之后，后续的 module 都会通过根节点(Module 对象)的 addChild 函数进行添加</p>
<p>modules 结构如下：<br><a target="_blank" rel="noopener" href="https://imgse.com/i/pAWHwB4"><img src="https://s21.ax1x.com/2024/11/21/pAWHwB4.png" alt="pAWHwB4.png"></a></p>
<p>可以看到有一个根节点，然后其下的 state 才是保存的实际的项目中的 storeModule</p>
<ul>
<li><p>在 vuex 初始化时执行这个函数,进入 register 流程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">ModuleCollection</span> = <span class="keyword">function</span> <span class="title function_">ModuleCollection</span>(<span class="params">rawRootModule</span>) &#123;</span><br><span class="line">  <span class="comment">// register root module (Vuex.Store options)</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">register</span>([], rawRootModule, <span class="literal">false</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>创建 module 的根节点<br>这里由于是第一次调用的话，path 默认就是个空数组，所以调用 ModuleCollection 的 register 都会先创建一个 modules 的根节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> newModule = <span class="keyword">new</span> <span class="title class_">Module</span>(rawModule, runtime);</span><br><span class="line"><span class="comment">// 由于调用register的时候传入的path是个空数组，所以这里会把第一个创建的module作为根节点</span></span><br><span class="line"><span class="keyword">if</span> (path.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">root</span> = newModule;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> parent = <span class="variable language_">this</span>.<span class="title function_">get</span>(path.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>));</span><br><span class="line">  parent.<span class="title function_">addChild</span>(path[path.<span class="property">length</span> - <span class="number">1</span>], newModule);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环调用 register，将项目中的 store 循环放在根节点的 children 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// register nested modules</span></span><br><span class="line"><span class="keyword">if</span> (rawModule.<span class="property">modules</span>) &#123;</span><br><span class="line">  <span class="title function_">forEachValue</span>(rawModule.<span class="property">modules</span>, <span class="keyword">function</span> (<span class="params">rawChildModule, key</span>) &#123;</span><br><span class="line">    <span class="comment">// 这里执行的也是ModuleCollection的register函数，不过由于path里面已经有数据了，所以这里走的是上一步的else流程</span></span><br><span class="line">    <span class="variable language_">this</span>$1.<span class="title function_">register</span>(path.<span class="title function_">concat</span>(key), rawChildModule, runtime);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="installModule"><a href="#installModule" class="headerlink" title="installModule"></a>installModule</h3><p>这个函数主要是用于将上一步得到的_modules 进行处理，然后循环注册 module 的 getter、action、mutation 等</p>
<ul>
<li><p>前置处理<br>判断当前是否是根节点，如果是非根节点，即项目中的每个 module，把这些放在根节点的 state 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否是根节点，实际只有从Store中初始化的入口，其他进入的都是非根节点</span></span><br><span class="line"><span class="keyword">var</span> isRoot = !path.<span class="property">length</span>;</span><br><span class="line"><span class="keyword">var</span> namespace = store.<span class="property">_modules</span>.<span class="title function_">getNamespace</span>(path);</span><br><span class="line"></span><br><span class="line"><span class="comment">// register in namespace map</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">module</span>.<span class="property">namespaced</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    store.<span class="property">_modulesNamespaceMap</span>[namespace] &amp;&amp;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">      <span class="string">&quot;[vuex] duplicate namespace &quot;</span> +</span><br><span class="line">        namespace +</span><br><span class="line">        <span class="string">&quot; for the namespaced module &quot;</span> +</span><br><span class="line">        path.<span class="title function_">join</span>(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  store.<span class="property">_modulesNamespaceMap</span>[namespace] = <span class="variable language_">module</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set state</span></span><br><span class="line"><span class="keyword">if</span> (!isRoot &amp;&amp; !hot) &#123;</span><br><span class="line">  <span class="keyword">var</span> parentState = <span class="title function_">getNestedState</span>(rootState, path.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>));</span><br><span class="line">  <span class="keyword">var</span> moduleName = path[path.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">  store.<span class="title function_">_withCommit</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (moduleName <span class="keyword">in</span> parentState) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">&#x27;[vuex] state field &quot;&#x27;</span> +</span><br><span class="line">            moduleName +</span><br><span class="line">            <span class="string">&#x27;&quot; was overridden by a module with the same name at &quot;&#x27;</span> +</span><br><span class="line">            path.<span class="title function_">join</span>(<span class="string">&quot;.&quot;</span>) +</span><br><span class="line">            <span class="string">&#x27;&quot;&#x27;</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将module的state都挂到根节点的state上</span></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="title function_">set</span>(parentState, moduleName, <span class="variable language_">module</span>.<span class="property">state</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环注册每个模块的 getter、action、mutation</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="title function_">forEachMutation</span>(<span class="keyword">function</span> (<span class="params">mutation, key</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> namespacedType = namespace + key;</span><br><span class="line">  <span class="title function_">registerMutation</span>(store, namespacedType, mutation, local);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="title function_">forEachAction</span>(<span class="keyword">function</span> (<span class="params">action, key</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> type = action.<span class="property">root</span> ? key : namespace + key;</span><br><span class="line">  <span class="keyword">var</span> handler = action.<span class="property">handler</span> || action;</span><br><span class="line">  <span class="title function_">registerAction</span>(store, type, handler, local);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="title function_">forEachGetter</span>(<span class="keyword">function</span> (<span class="params">getter, key</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> namespacedType = namespace + key;</span><br><span class="line">  <span class="title function_">registerGetter</span>(store, namespacedType, getter, local);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环执行每个 module<br>对项目中的每个 module 每次都走一个第一步</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="title function_">forEachChild</span>(<span class="keyword">function</span> (<span class="params">child, key</span>) &#123;</span><br><span class="line">  <span class="title function_">installModule</span>(store, rootState, path.<span class="title function_">concat</span>(key), child, hot);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="resetStoreVM-this-state"><a href="#resetStoreVM-this-state" class="headerlink" title="resetStoreVM(this, state);"></a>resetStoreVM(this, state);</h3><p>这个主要是用于初始化 store 上的<code>_vm</code>，以及将 gettter 放到 store 的<code>getters</code>上，即走了这一步，store 里面才有 getter。dispatch、commit 等是直接挂载在 Store.prototype 上的</p>
<ul>
<li><p>挂载 getters<br>这里是将_wrappedGetters 的数据挂载到 store 里面的 getter 上，_wrappedGetters 是执行的函数，getters 是执行的结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> oldVm = store.<span class="property">_vm</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(store);</span><br><span class="line"><span class="comment">// bind store public getters</span></span><br><span class="line">store.<span class="property">getters</span> = &#123;&#125;;</span><br><span class="line"><span class="comment">// reset local getters cache</span></span><br><span class="line">store.<span class="property">_makeLocalGettersCache</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">var</span> wrappedGetters = store.<span class="property">_wrappedGetters</span>;</span><br><span class="line"><span class="keyword">var</span> computed = &#123;&#125;;</span><br><span class="line"><span class="title function_">forEachValue</span>(wrappedGetters, <span class="keyword">function</span> (<span class="params">fn, key</span>) &#123;</span><br><span class="line">  <span class="comment">// use computed to leverage its lazy-caching mechanism</span></span><br><span class="line">  <span class="comment">// direct inline function use will lead to closure preserving oldVm.</span></span><br><span class="line">  <span class="comment">// using partial to return function with only arguments preserved in closure environment.</span></span><br><span class="line">  computed[key] = <span class="title function_">partial</span>(fn, store);</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(store.<span class="property">getters</span>, key, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> store.<span class="property">_vm</span>[key];</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="comment">// for local getters</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li><p>对 store 的_vm 重新赋值<br>这里的 state 是_modules 根节点的 state</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> silent = <span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">silent</span>;</span><br><span class="line"><span class="comment">// 暂时将Vue设为静默模式，避免报出用户加载的某些插件触发的警告</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">silent</span> = <span class="literal">true</span>;</span><br><span class="line">store.<span class="property">_vm</span> = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">$$state</span>: state,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">computed</span>: computed,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 恢复Vue的模式</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">silent</span> = silent;</span><br><span class="line"><span class="comment">// 如果设置了严格模式</span></span><br><span class="line"><span class="keyword">if</span> (store.<span class="property">strict</span>) &#123;</span><br><span class="line">  <span class="title function_">enableStrictMode</span>(store);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>销毁老的 vm</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (oldVm) &#123;</span><br><span class="line">  <span class="keyword">if</span> (hot) &#123;</span><br><span class="line">    <span class="comment">// dispatch changes in all subscribed watchers</span></span><br><span class="line">    <span class="comment">// to force getter re-evaluation for hot reloading.</span></span><br><span class="line">    store.<span class="title function_">_withCommit</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      oldVm.<span class="property">_data</span>.<span class="property">$$state</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="title function_">nextTick</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> oldVm.$destroy();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="模块函数注册"><a href="#模块函数注册" class="headerlink" title="模块函数注册"></a>模块函数注册</h3><p>在installModule中，会对每个模块进行mutation、action、getter的注册</p>
<ul>
<li><p>registerMutation<br>  调用方：<br>  module.forEachMutation是将_modules中的mutation取出来，然后循环执行回调函数</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="title function_">forEachMutation</span>(<span class="keyword">function</span> (<span class="params">mutation, key</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> namespacedType = namespace + key;</span><br><span class="line">    <span class="title function_">registerMutation</span>(store, namespacedType, mutation, local);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="comment">// this._rawModule.mutations.foreach()</span></span><br></pre></td></tr></table></figure>
<p>  获取到对应的muation，这里的创建store的_muation的地方</p>
<p>  如果没有同名的muation，那么就创建出；然后再将项目的muation包装一下，增加到store的_mutation中</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">registerMutation</span> (<span class="params">store, type, handler, local</span>) &#123;</span><br><span class="line"><span class="comment">//    创建muation的地方 store._mutations[type] = []</span></span><br><span class="line"><span class="keyword">var</span> entry = store.<span class="property">_mutations</span>[type] || (store.<span class="property">_mutations</span>[type] = []);</span><br><span class="line">entry.<span class="title function_">push</span>(<span class="keyword">function</span> <span class="title function_">wrappedMutationHandler</span> (<span class="params">payload</span>) &#123;</span><br><span class="line">    <span class="comment">// handler就是实际项目中的的muation，将执行的this绑定到store中，</span></span><br><span class="line">    <span class="comment">// local是`module.context`，是在创建Module的时候，传入的 </span></span><br><span class="line">    <span class="comment">// installModule 中的 var local = module.context = makeLocalContext(store, namespace, path);</span></span><br><span class="line">    <span class="comment">// 即在上一步中，每个Module创建时的</span></span><br><span class="line">    <span class="comment">//  ModuleCollection根节点，其下_children里面的Module</span></span><br><span class="line">    handler.<span class="title function_">call</span>(store, local.<span class="property">state</span>, payload);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  <a target="_blank" rel="noopener" href="https://imgse.com/i/pAf1YiF"><img src="https://s21.ax1x.com/2024/11/22/pAf1YiF.png" alt="pAf1YiF.png"></a></p>
<p>  注意，vuex中的muation和dispatch都是数组，只有getter是非数组</p>
</li>
<li><p>平时在执行commit时的顺序</p>
<ul>
<li>Store初始化中的<code>this.commit</code></li>
<li>Store原型链中的<code>Store.prototype.commit</code></li>
<li>注册mutation中（上一步）的<code>wrappedMutationHandler</code></li>
</ul>
</li>
<li><p>registerAction<br>  module.forEachAction是将_modules中的action（action.handler || action）取出来，然后循环执行回调函数</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">function</span> <span class="title function_">registerAction</span> (<span class="params">store, type, handler, local</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取到对应的action函数，即项目中实际写的dispatch回调</span></span><br><span class="line">  <span class="keyword">var</span> entry = store.<span class="property">_actions</span>[type] || (store.<span class="property">_actions</span>[type] = []);</span><br><span class="line">  <span class="comment">// 因为action和mutation都是一个数组，所以用的是push方法，将对应的dispatchType放到数组中</span></span><br><span class="line">  <span class="comment">// 这里就是调用项目中dispatch回调，在调用之前包了一层，将执行作用于绑定到store中，</span></span><br><span class="line">  <span class="comment">// dispatch中的两个参数也是在这里进行传递的</span></span><br><span class="line">  entry.<span class="title function_">push</span>(<span class="keyword">function</span> <span class="title function_">wrappedActionHandler</span> (<span class="params">payload</span>) &#123;</span><br><span class="line">    <span class="comment">// dispath的root就是第二个参数，调用时传递的数据是payload</span></span><br><span class="line">    <span class="keyword">var</span> res = handler.<span class="title function_">call</span>(store, &#123;</span><br><span class="line">      <span class="attr">dispatch</span>: local.<span class="property">dispatch</span>,</span><br><span class="line">      <span class="attr">commit</span>: local.<span class="property">commit</span>,</span><br><span class="line">      <span class="attr">getters</span>: local.<span class="property">getters</span>,</span><br><span class="line">      <span class="attr">state</span>: local.<span class="property">state</span>,</span><br><span class="line">      <span class="attr">rootGetters</span>: store.<span class="property">getters</span>,</span><br><span class="line">      <span class="attr">rootState</span>: store.<span class="property">state</span></span><br><span class="line">    &#125;, payload);</span><br><span class="line">    <span class="comment">// dispatch是promise的处理</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isPromise</span>(res)) &#123;</span><br><span class="line">      res = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(res);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (store.<span class="property">_devtoolHook</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">        store.<span class="property">_devtoolHook</span>.<span class="title function_">emit</span>(<span class="string">&#x27;vuex:error&#x27;</span>, err);</span><br><span class="line">        <span class="keyword">throw</span> err</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>平时在执行dispatch时的顺序</p>
<ul>
<li>Store初始化中的<code>this.dispatch</code></li>
<li>Store原型链中的<code>Store.prototype.dispatch</code></li>
<li>注册dispatch中（上一步）的<code>registerAction</code>中entry包过的函数</li>
</ul>
</li>
<li><p>registerGetter<br>  module.forEachAction是将_modules中的getters取出来，然后循环执行回调函数<br>  rawGetter和action第三个参数一样，都是getter的回调</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">function</span> <span class="title function_">registerGetter</span> (<span class="params">store, type, rawGetter, local</span>) &#123;</span><br><span class="line">    <span class="comment">// gettter不能有重复命名的，所以会报错，这个是和action、mutation不同的点</span></span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">_wrappedGetters</span>[type]) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>((<span class="string">&quot;[vuex] duplicate getter key: &quot;</span> + type));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// store就是Store，是初始创建的</span></span><br><span class="line">  store.<span class="property">_wrappedGetters</span>[type] = <span class="keyword">function</span> <span class="title function_">wrappedGetter</span> (<span class="params">store</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">rawGetter</span>(</span><br><span class="line">      local.<span class="property">state</span>, <span class="comment">// local state</span></span><br><span class="line">      local.<span class="property">getters</span>, <span class="comment">// local getters</span></span><br><span class="line">      store.<span class="property">state</span>, <span class="comment">// root state</span></span><br><span class="line">      store.<span class="property">getters</span> <span class="comment">// root getters</span></span><br><span class="line">    )</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>平时在执行getter时的顺序</p>
<ul>
<li>先遍历执行一次<code>module.forEachGetter</code></li>
<li>调用的时候执行resetStoreVm中，将getter调用<code>store._vm[key]</code>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(store.<span class="property">getters</span>, key, &#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123; </span><br><span class="line">    <span class="keyword">debugger</span></span><br><span class="line">    <span class="keyword">return</span> store.<span class="property">_vm</span>[key];</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span> <span class="comment">// for local getters</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li>执行registerGetter中封装好的getter</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91vuex-%E5%88%9D%E5%A7%8B%E5%8C%96/" data-id="cmf67fxen0082bcfm2fbs1srd" data-title="vuex-流程" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vuex-%E6%BA%90%E7%A0%81/" rel="tag">vuex 源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-源码/【源码】axios-拦截器" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91axios-%E6%8B%A6%E6%88%AA%E5%99%A8/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:33.939Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/axios-%E6%BA%90%E7%A0%81/">axios 源码</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91axios-%E6%8B%A6%E6%88%AA%E5%99%A8/">axios拦截器原理</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="拦截器使用"><a href="#拦截器使用" class="headerlink" title="拦截器使用"></a>拦截器使用</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// http request 拦截器</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">config: any</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;请求拦截器&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http response 拦截器</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;响应拦截器&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> response.<span class="property">data</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">onError</span>(<span class="string">&quot;系统异常！&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">axios.<span class="title function_">get</span>(url).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;请求结果&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 输出结果：</span></span><br><span class="line"><span class="comment">// 请求拦截器</span></span><br><span class="line"><span class="comment">// 请求结果</span></span><br><span class="line"><span class="comment">// 响应拦截器</span></span><br></pre></td></tr></table></figure>

<h2 id="入口代码"><a href="#入口代码" class="headerlink" title="入口代码"></a>入口代码</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/core/axios.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Axios</span>(<span class="params">instanceConfig</span>) &#123;</span><br><span class="line">  <span class="comment">// 分别设置请求和响应拦截器管理</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interceptors</span> = &#123;</span><br><span class="line">    <span class="attr">request</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>(),</span><br><span class="line">    <span class="attr">response</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>(),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">request</span> = <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">configOrUrl, config</span>) &#123;</span><br><span class="line">  <span class="comment">// 不相关代码...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// filter out skipped interceptors</span></span><br><span class="line">  <span class="comment">// 请求拦截器相关</span></span><br><span class="line">  <span class="keyword">var</span> requestInterceptorChain = [];</span><br><span class="line">  <span class="keyword">var</span> synchronousRequestInterceptors = <span class="literal">true</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">unshiftRequestInterceptors</span>(<span class="params"></span></span><br><span class="line"><span class="params">    interceptor</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="keyword">typeof</span> interceptor.<span class="property">runWhen</span> === <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">      interceptor.<span class="title function_">runWhen</span>(config) === <span class="literal">false</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synchronousRequestInterceptors =</span><br><span class="line">      synchronousRequestInterceptors &amp;&amp; interceptor.<span class="property">synchronous</span>;</span><br><span class="line"></span><br><span class="line">    requestInterceptorChain.<span class="title function_">unshift</span>(</span><br><span class="line">      interceptor.<span class="property">fulfilled</span>,</span><br><span class="line">      interceptor.<span class="property">rejected</span></span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 响应拦截器相关代码</span></span><br><span class="line">  <span class="keyword">var</span> responseInterceptorChain = [];</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">pushResponseInterceptors</span>(<span class="params"></span></span><br><span class="line"><span class="params">    interceptor</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    responseInterceptorChain.<span class="title function_">push</span>(interceptor.<span class="property">fulfilled</span>, interceptor.<span class="property">rejected</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> promise;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!synchronousRequestInterceptors) &#123;</span><br><span class="line">    <span class="keyword">var</span> chain = [dispatchRequest, <span class="literal">undefined</span>];</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">unshift</span>.<span class="title function_">apply</span>(chain, requestInterceptorChain);</span><br><span class="line">    chain = chain.<span class="title function_">concat</span>(responseInterceptorChain);</span><br><span class="line"></span><br><span class="line">    promise = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(config);</span><br><span class="line">    <span class="keyword">while</span> (chain.<span class="property">length</span>) &#123;</span><br><span class="line">      promise = promise.<span class="title function_">then</span>(chain.<span class="title function_">shift</span>(), chain.<span class="title function_">shift</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> newConfig = config;</span><br><span class="line">  <span class="keyword">while</span> (requestInterceptorChain.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> onFulfilled = requestInterceptorChain.<span class="title function_">shift</span>();</span><br><span class="line">    <span class="keyword">var</span> onRejected = requestInterceptorChain.<span class="title function_">shift</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      newConfig = <span class="title function_">onFulfilled</span>(newConfig);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="title function_">onRejected</span>(error);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    promise = <span class="title function_">dispatchRequest</span>(newConfig);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (responseInterceptorChain.<span class="property">length</span>) &#123;</span><br><span class="line">    promise = promise.<span class="title function_">then</span>(</span><br><span class="line">      responseInterceptorChain.<span class="title function_">shift</span>(),</span><br><span class="line">      responseInterceptorChain.<span class="title function_">shift</span>()</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="拦截器管理"><a href="#拦截器管理" class="headerlink" title="拦截器管理"></a>拦截器管理</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/core/InterceptorManager.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">&quot;./../utils&quot;</span>);</span><br><span class="line"><span class="comment">// 回调数组</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">InterceptorManager</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">handlers</span> = [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将新的拦截器添加到回调中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; fulfilled The function to handle `then` for a `Promise`</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; rejected The function to handle `reject` for a `Promise`</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">Number</span>&#125; An ID used to remove interceptor later</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">InterceptorManager</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">use</span> = <span class="keyword">function</span> <span class="title function_">use</span>(<span class="params">fulfilled, rejected, options</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">handlers</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">    <span class="attr">fulfilled</span>: fulfilled,</span><br><span class="line">    <span class="attr">rejected</span>: rejected,</span><br><span class="line">    <span class="attr">synchronous</span>: options ? options.<span class="property">synchronous</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">runWhen</span>: options ? options.<span class="property">runWhen</span> : <span class="literal">null</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">handlers</span>.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除拦截器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; id The ID that was returned by `use`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">InterceptorManager</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">eject</span> = <span class="keyword">function</span> <span class="title function_">eject</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handlers</span>[id]) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handlers</span>[id] = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历拦截器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; fn The function to call for each interceptor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">InterceptorManager</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span> = <span class="keyword">function</span> <span class="title function_">forEach</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  utils.<span class="title function_">forEach</span>(<span class="variable language_">this</span>.<span class="property">handlers</span>, <span class="keyword">function</span> <span class="title function_">forEachHandler</span>(<span class="params">h</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (h !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">fn</span>(h);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">InterceptorManager</span>;</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<ul>
<li><code>InterceptorManager</code>是一个管理拦截器的类，它包含一个<code>handlers</code>数组，用于存储拦截器。<code>use</code>方法用于添加拦截器，<code>eject</code>方法用于删除拦截器，<code>forEach</code>方法用于遍历拦截器。</li>
<li>在使用拦截器时，调用的<code>use</code>实际上是调用的<code>InterceptorManager</code>的<code>use</code>方法</li>
</ul>
<h2 id="请求拦截器"><a href="#请求拦截器" class="headerlink" title="请求拦截器"></a>请求拦截器</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> requestInterceptorChain = [];</span><br><span class="line"><span class="keyword">var</span> synchronousRequestInterceptors = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// this.interceptors指向的是在文件`/lib/core/Axios.js`中Axios方法中定义的`this.interceptors`</span></span><br><span class="line"><span class="comment">// this.interceptors是一个InterceptorManager实例</span></span><br><span class="line"><span class="comment">// 在外部(项目)调用axios.interceptors.request的时候，会把对应的请求回调加入到this.interceptors.request的handlers中</span></span><br><span class="line"><span class="comment">// 这里的this.interceptors.request实际调用的是InterceptorManager的`forEach`方法，所以这里的foreach实际是遍历this.interceptors.request的handlers数组</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">unshiftRequestInterceptors</span>(<span class="params"></span></span><br><span class="line"><span class="params">  interceptor</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> interceptor.<span class="property">runWhen</span> === <span class="string">&quot;function&quot;</span> &amp;&amp;</span><br><span class="line">    interceptor.<span class="title function_">runWhen</span>(config) === <span class="literal">false</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断请求拦截器中是否有异步的函数</span></span><br><span class="line">  synchronousRequestInterceptors =</span><br><span class="line">    synchronousRequestInterceptors &amp;&amp; interceptor.<span class="property">synchronous</span>;</span><br><span class="line">  <span class="comment">// 将请求拦截器的回调方法加入到requestInterceptorChain中，注意这里其实是以request的顺序倒叙了一次</span></span><br><span class="line">  <span class="comment">// 即如果request.handlers = [1,2,3]</span></span><br><span class="line">  <span class="comment">// 那么requestInterceptorChain = [3,2,1]</span></span><br><span class="line">  requestInterceptorChain.<span class="title function_">unshift</span>(interceptor.<span class="property">fulfilled</span>, interceptor.<span class="property">rejected</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 如果请求拦截器中有异步的函数</span></span><br><span class="line"><span class="keyword">if</span> (!synchronousRequestInterceptors) &#123;</span><br><span class="line">  <span class="comment">// dispatchRequest是实际的请求</span></span><br><span class="line">    <span class="keyword">var</span> chain = [dispatchRequest, <span class="literal">undefined</span>];</span><br><span class="line">    <span class="comment">// chain组成一个[请求拦截器1成功， 请求拦截器1失败，请求拦截器2成功，请求拦截器2失败，实际请求，响应拦截器1成功，响应拦截器1失败，响应拦截器2成功，响应拦截器2失败]</span></span><br><span class="line">    <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">unshift</span>.<span class="title function_">apply</span>(chain, requestInterceptorChain);</span><br><span class="line">    chain = chain.<span class="title function_">concat</span>(responseInterceptorChain);</span><br><span class="line"></span><br><span class="line">    promise = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(config);</span><br><span class="line">    <span class="keyword">while</span> (chain.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="comment">// 执行顺序应该为：</span></span><br><span class="line">      <span class="comment">// promise.then(请求拦截器1成功， 请求拦截器1失败)</span></span><br><span class="line">      <span class="comment">// promise.then(请求拦截器2成功，请求拦截器2失败)</span></span><br><span class="line">      <span class="comment">// promise.then(实际请求, undefined)</span></span><br><span class="line">      <span class="comment">// promise.then(响应拦截器1成功，响应拦截器1失败)</span></span><br><span class="line">      <span class="comment">// promise.then(响应拦截器2成功，响应拦截器2失败)</span></span><br><span class="line">      promise = promise.<span class="title function_">then</span>(chain.<span class="title function_">shift</span>(), chain.<span class="title function_">shift</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 无关代码...</span></span><br><span class="line"><span class="comment">// 将原有的请求配置浅拷贝一份出来</span></span><br><span class="line"><span class="keyword">var</span> newConfig = config;</span><br><span class="line"><span class="comment">// 循环执行requestInterceptorChain中的回调方法;</span></span><br><span class="line"><span class="keyword">while</span> (requestInterceptorChain.<span class="property">length</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> onFulfilled = requestInterceptorChain.<span class="title function_">shift</span>();</span><br><span class="line">  <span class="keyword">var</span> onRejected = requestInterceptorChain.<span class="title function_">shift</span>();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 执行新的请求拦截器，并将请求拦截器的结果作为下一次执行请求拦截器的参数</span></span><br><span class="line">    newConfig = <span class="title function_">onFulfilled</span>(newConfig);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="comment">// 如果请求拦截器中报错，那么不执行后续的操作</span></span><br><span class="line">    <span class="title function_">onRejected</span>(error);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 执行请求</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  promise = <span class="title function_">dispatchRequest</span>(newConfig);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<ul>
<li>请求拦截器的执行顺序是与书写顺序相反的<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">config: any</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;请求拦截器1&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">config: any</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;请求拦截器2&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 执行结果：</span></span><br><span class="line"><span class="comment">// 请求拦截器2</span></span><br><span class="line"><span class="comment">// 请求拦截器1</span></span><br></pre></td></tr></table></figure></li>
<li>请求拦截器中如果报错，那么不执行后续的操作</li>
<li>如果请求拦截器中传入<code>synchronous=false</code>表示为异步请求，默认都是异步请求处理操作</li>
<li>如果是异步请求，axios是和相应拦截器一样的处理，用Promise包裹了一层</li>
<li>如果是同步请求，那么是直接循环执行的</li>
</ul>
<h2 id="响应拦截器"><a href="#响应拦截器" class="headerlink" title="响应拦截器"></a>响应拦截器</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  <span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">request</span> = <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">configOrUrl, config</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 响应拦截器数组</span></span><br><span class="line">  <span class="keyword">var</span> responseInterceptorChain = [];</span><br><span class="line">  <span class="comment">// 按书写顺序将响应拦截器加入到数组中</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">pushResponseInterceptors</span>(<span class="params">interceptor</span>) &#123;</span><br><span class="line">    responseInterceptorChain.<span class="title function_">push</span>(interceptor.<span class="property">fulfilled</span>, interceptor.<span class="property">rejected</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 无关代码...</span></span><br><span class="line">  <span class="keyword">var</span> promise;</span><br><span class="line">  <span class="comment">// 执行真实请求</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    promise = <span class="title function_">dispatchRequest</span>(newConfig);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 按书写顺序执行响应拦截器，并且是以异步执行的</span></span><br><span class="line">  <span class="keyword">while</span> (responseInterceptorChain.<span class="property">length</span>) &#123;</span><br><span class="line">    promise = promise.<span class="title function_">then</span>(responseInterceptorChain.<span class="title function_">shift</span>(), responseInterceptorChain.<span class="title function_">shift</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>总结：</p>
<ul>
<li>与请求拦截器执行顺序不同，响应拦截器按书写顺序执行</li>
<li>响应拦截器是默认用异步函数包裹了一层，而请求拦截器是将同步和异步分为两种情况的</li>
</ul>
<h2 id="参链"><a href="#参链" class="headerlink" title="参链"></a>参链</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&mid=2650744604&idx=1&sn=51d8d865c9848fd59f7763f5fb9ce789&chksm=88662490bf11ad86061ae76ff71a1177eeddab02c38d046eecd0e1ad25dc16f7591f91e9e3b2&scene=21#wechat_redirect">学习 axios 源码整体架构，打造属于自己的请求库</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.axios-js.com/zh-cn/docs/#axios-spread-callback">axios官网</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91axios-%E6%8B%A6%E6%88%AA%E5%99%A8/" data-id="cmf67fxem007ubcfmcg689ack" data-title="axios拦截器原理" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/axios-%E6%BA%90%E7%A0%81/" rel="tag">axios 源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-源码/【源码】axios-取消请求" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91axios-%E5%8F%96%E6%B6%88%E8%AF%B7%E6%B1%82/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:33.934Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/axios-%E6%BA%90%E7%A0%81/">axios 源码</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91axios-%E5%8F%96%E6%B6%88%E8%AF%B7%E6%B1%82/">axios取消请求原理</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://imgse.com/i/pFqWBin"><img src="https://s21.ax1x.com/2024/04/07/pFqWBin.png" alt="pFqWBin.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pFqWrR0"><img src="https://s21.ax1x.com/2024/04/07/pFqWrR0.png" alt="pFqWrR0.png"></a></p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">CancelToken</span> = axios.<span class="property">CancelToken</span>;</span><br><span class="line"><span class="keyword">const</span> source = <span class="title class_">CancelToken</span>.<span class="title function_">source</span>();</span><br><span class="line"></span><br><span class="line">axios</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&quot;/get/server&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">cancelToken</span>: source.<span class="property">token</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (axios.<span class="title function_">isCancel</span>(err)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;请求取消&quot;</span>, err.<span class="property">message</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// handle error</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取消函数。</span></span><br><span class="line">source.<span class="title function_">cancel</span>(<span class="string">&quot;调用cancel方法&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="取消类"><a href="#取消类" class="headerlink" title="取消类"></a>取消类</h2><h3 id="CancelToken"><a href="#CancelToken" class="headerlink" title="CancelToken"></a>CancelToken</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/cancel/CancelToken.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CancelToken</span>(<span class="params">executor</span>) &#123;</span><br><span class="line">  <span class="comment">// executor传入的函数，参数是取消函数，调用这个参数可以直接取消请求</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> executor !== <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&quot;executor must be a function.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> resolvePromise;</span><br><span class="line">  <span class="comment">// 实例化一个Promise</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">promise</span> = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> <span class="title function_">promiseExecutor</span>(<span class="params">resolve</span>) &#123;</span><br><span class="line">    resolvePromise = resolve;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> token = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="comment">// 如果执行了取消，那么就执行监听取消的函数</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">promise</span>.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">cancel</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!token.<span class="property">_listeners</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> i;</span><br><span class="line">    <span class="keyword">var</span> l = token.<span class="property">_listeners</span>.<span class="property">length</span>;</span><br><span class="line">    <span class="comment">// 循环执行</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">      token.<span class="property">_listeners</span>[i](cancel);</span><br><span class="line">    &#125;</span><br><span class="line">    token.<span class="property">_listeners</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这个没有在axios里面看到使用过，猜测应该是之前老axios遗留代码</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">promise</span>.<span class="property">then</span> = <span class="keyword">function</span> (<span class="params">onfulfilled</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> _resolve;</span><br><span class="line">    <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123;</span><br><span class="line">      token.<span class="title function_">subscribe</span>(resolve);</span><br><span class="line">      _resolve = resolve;</span><br><span class="line">    &#125;).<span class="title function_">then</span>(onfulfilled);</span><br><span class="line"></span><br><span class="line">    promise.<span class="property">cancel</span> = <span class="keyword">function</span> <span class="title function_">reject</span>(<span class="params"></span>) &#123;</span><br><span class="line">      token.<span class="title function_">unsubscribe</span>(_resolve);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 执行传入的函数，当source.cancel时，就执行这个回调</span></span><br><span class="line">  <span class="title function_">executor</span>(<span class="keyword">function</span> <span class="title function_">cancel</span>(<span class="params">message</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果已经有reason，那么表示是已经取消请求了</span></span><br><span class="line">    <span class="keyword">if</span> (token.<span class="property">reason</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 把CanceledError实例作为一个reason，并且把message作为reason的message</span></span><br><span class="line">    token.<span class="property">reason</span> = <span class="keyword">new</span> <span class="title class_">CanceledError</span>(message);</span><br><span class="line">    <span class="comment">// 执行this.promise.then()的回调</span></span><br><span class="line">    <span class="title function_">resolvePromise</span>(token.<span class="property">reason</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断是否已经取消，因为只有reason有值时，才表示已经取消请求了</span></span><br><span class="line"><span class="comment"> * 如果已经取消请求，那么直接抛出错误，走入catch</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">CancelToken</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">throwIfRequested</span> = <span class="keyword">function</span> <span class="title function_">throwIfRequested</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">reason</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="variable language_">this</span>.<span class="property">reason</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加取消监听函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">CancelToken</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">subscribe</span> = <span class="keyword">function</span> <span class="title function_">subscribe</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果已经执行取消，那么就直接执行监听函数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">reason</span>) &#123;</span><br><span class="line">    <span class="title function_">listener</span>(<span class="variable language_">this</span>.<span class="property">reason</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将监听函数加入数组中</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_listeners</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_listeners</span>.<span class="title function_">push</span>(listener);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_listeners</span> = [listener];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除监听函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">CancelToken</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">unsubscribe</span> = <span class="keyword">function</span> <span class="title function_">unsubscribe</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_listeners</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="variable language_">this</span>.<span class="property">_listeners</span>.<span class="title function_">indexOf</span>(listener);</span><br><span class="line">  <span class="keyword">if</span> (index !== -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_listeners</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns an object that contains a new `CancelToken` and a function that, when called,</span></span><br><span class="line"><span class="comment"> * cancels the `CancelToken`.</span></span><br><span class="line"><span class="comment"> * 调用创建取消token的函数，返回一个对象，包含一个取消token和一个取消函数</span></span><br><span class="line"><span class="comment"> * token是返回的函数实例，即可以直接访问函数内部</span></span><br><span class="line"><span class="comment"> * cancel是在CancelToken里面执行executor时，里面包裹的回调函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">CancelToken</span>.<span class="property">source</span> = <span class="keyword">function</span> <span class="title function_">source</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> cancel;</span><br><span class="line">  <span class="comment">// 创建一个实例</span></span><br><span class="line">  <span class="keyword">var</span> token = <span class="keyword">new</span> <span class="title class_">CancelToken</span>(<span class="keyword">function</span> <span class="title function_">executor</span>(<span class="params">c</span>) &#123;</span><br><span class="line">    cancel = c;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回实例和取消调用的函数</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">token</span>: token,</span><br><span class="line">    <span class="attr">cancel</span>: cancel,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">CancelToken</span>;</span><br></pre></td></tr></table></figure>

<h2 id="取消调用流程"><a href="#取消调用流程" class="headerlink" title="取消调用流程"></a>取消调用流程</h2><p>以下是以浏览器的流程为示例</p>
<ul>
<li><p><code>dispatchRequest</code>中判断一次此请求是否确认取消</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/core/dispatchRequest.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throwIfCancellationRequested</span>(<span class="params">config</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果有cancelToken，那么表示这个请求是可被取消的，调用cancelToken的请求取消报错即可结束</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">cancelToken</span>) &#123;</span><br><span class="line">    config.<span class="property">cancelToken</span>.<span class="title function_">throwIfRequested</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">signal</span> &amp;&amp; config.<span class="property">signal</span>.<span class="property">aborted</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CanceledError</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 xhr 文件中，进行取消监听函数的添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果配置列表里有cancelToken，那么表示需要走取消监听</span></span><br><span class="line"><span class="comment">// /lib/adapters/xhr</span></span><br><span class="line"><span class="keyword">if</span> (config.<span class="property">cancelToken</span> || config.<span class="property">signal</span>) &#123;</span><br><span class="line">    <span class="comment">// 取消函数的回调</span></span><br><span class="line">    onCanceled = <span class="keyword">function</span>(<span class="params">cancel</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果这个请求已经进行完成了,那么就不走后面的函数</span></span><br><span class="line">      <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果这个请求还没有结束或者取消,那么就使请求回调走入catch中</span></span><br><span class="line">      <span class="title function_">reject</span>(!cancel || (cancel &amp;&amp; cancel.<span class="property">type</span>) ? <span class="keyword">new</span> <span class="title class_">CanceledError</span>() : cancel);</span><br><span class="line">      <span class="comment">// 取消请求.调用xhr的取消</span></span><br><span class="line">      request.<span class="title function_">abort</span>();</span><br><span class="line">      <span class="comment">// 表明请求已经结束,防止重复取消</span></span><br><span class="line">      request = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 如果有cancelToken,那么就添加取消函数</span></span><br><span class="line">    config.<span class="property">cancelToken</span> &amp;&amp; config.<span class="property">cancelToken</span>.<span class="title function_">subscribe</span>(onCanceled);</span><br><span class="line">   <span class="comment">// 这个是针对于fetch的取消处理</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">signal</span>) &#123;</span><br><span class="line">      config.<span class="property">signal</span>.<span class="property">aborted</span> ? <span class="title function_">onCanceled</span>() : config.<span class="property">signal</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;abort&#x27;</span>, onCanceled);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>onCanceled</code>这个函数的执行是在调用<code>source.cancel()</code>执行的</p>
</li>
<li><p>请求结束后,在 xhr 的<code>onloadend</code>&#x2F;<code>onreadystatechange</code>也进行了处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求结束之后的回调,不管是失败还是成功都会执行</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">done</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 如果有cancelToken,那么就取消监听订阅的这个函数</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">cancelToken</span>) &#123;</span><br><span class="line">    config.<span class="property">cancelToken</span>.<span class="title function_">unsubscribe</span>(onCanceled);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// fetch则是取消监听取消的函数</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">signal</span>) &#123;</span><br><span class="line">    config.<span class="property">signal</span>.<span class="title function_">removeEventListener</span>(<span class="string">&quot;abort&quot;</span>, onCanceled);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">&quot;onloadend&quot;</span> <span class="keyword">in</span> request) &#123;</span><br><span class="line">  <span class="comment">// Use onloadend if available</span></span><br><span class="line">  request.<span class="property">onloadend</span> = onloadend;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(onloadend);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onloadend</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 如果请求已经取消,那么直接结束就行</span></span><br><span class="line">  <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> responseHeaders =</span><br><span class="line">    <span class="string">&quot;getAllResponseHeaders&quot;</span> <span class="keyword">in</span> request</span><br><span class="line">      ? <span class="title function_">parseHeaders</span>(request.<span class="title function_">getAllResponseHeaders</span>())</span><br><span class="line">      : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> responseData =</span><br><span class="line">    !responseType || responseType === <span class="string">&quot;text&quot;</span> || responseType === <span class="string">&quot;json&quot;</span></span><br><span class="line">      ? request.<span class="property">responseText</span></span><br><span class="line">      : request.<span class="property">response</span>;</span><br><span class="line">  <span class="keyword">var</span> response = &#123;</span><br><span class="line">    <span class="attr">data</span>: responseData,</span><br><span class="line">    <span class="attr">status</span>: request.<span class="property">status</span>,</span><br><span class="line">    <span class="attr">statusText</span>: request.<span class="property">statusText</span>,</span><br><span class="line">    <span class="attr">headers</span>: responseHeaders,</span><br><span class="line">    <span class="attr">config</span>: config,</span><br><span class="line">    <span class="attr">request</span>: request,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 用请求结果去进行判断</span></span><br><span class="line">  <span class="title function_">settle</span>(</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_resolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(value);</span><br><span class="line">      <span class="title function_">done</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_reject</span>(<span class="params">err</span>) &#123;</span><br><span class="line">      <span class="title function_">reject</span>(err);</span><br><span class="line">      <span class="title function_">done</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    response</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/core/settle.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">settle</span>(<span class="params">resolve, reject, response</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> validateStatus = response.<span class="property">config</span>.<span class="property">validateStatus</span>;</span><br><span class="line">  <span class="comment">// 如果请求返回状态是合理的,那么就直接resolve</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !response.<span class="property">status</span> ||</span><br><span class="line">    !validateStatus ||</span><br><span class="line">    <span class="title function_">validateStatus</span>(response.<span class="property">status</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(response);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">AxiosError</span>(</span><br><span class="line">        <span class="string">&quot;Request failed with status code &quot;</span> + response.<span class="property">status</span>,</span><br><span class="line">        [<span class="title class_">AxiosError</span>.<span class="property">ERR_BAD_REQUEST</span>, <span class="title class_">AxiosError</span>.<span class="property">ERR_BAD_RESPONSE</span>][</span><br><span class="line">          <span class="title class_">Math</span>.<span class="title function_">floor</span>(response.<span class="property">status</span> / <span class="number">100</span>) - <span class="number">4</span></span><br><span class="line">        ],</span><br><span class="line">        response.<span class="property">config</span>,</span><br><span class="line">        response.<span class="property">request</span>,</span><br><span class="line">        response</span><br><span class="line">      )</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>请求结束后,在<code>dispatchRequest</code>中,也有相对于取消请求的处理</p>
<p>其实和开始请求之前的逻辑一样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title function_">adapter</span>(config).<span class="title function_">then</span>(<span class="keyword">function</span> <span class="title function_">onAdapterResolution</span>(<span class="params">response</span>) &#123;</span><br><span class="line">  <span class="title function_">throwIfCancellationRequested</span>(config);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<p>总结: </p>
<ul>
<li><p>对于请求开始前和结束后,都是在<code>dispatchRequest</code>文件中调用<code>cancelToken.throwIfRequested()</code>进行请求取消的</p>
</li>
<li><p>对于已经开始请求的,分为两个</p>
<ul>
<li><p>请求结果还未返回: 调用<code>cancelToken.subscribe()</code>进行请求取消回调的<strong>添加</strong></p>
</li>
<li><p>请求结果已经返回: 调用<code>cancelToken.unsubscribe()</code>进行请求取消回调的<strong>删除</strong></p>
</li>
<li><p>取消请求回调具体是在外部调用<code>source.cancel</code>进行的,因此会存在请求结果前或者请求结果返回后都存在的情况</p>
</li>
</ul>
</li>
</ul>
<h2 id="参链"><a href="#参链" class="headerlink" title="参链"></a>参链</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7284417436752265277?searchId=202403261358326BBE4B654AB52795AB71">五分钟！让你彻底搞懂axios的请求取消原理！附源码分析</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA5MjQwMzQyNw==&mid=2650744604&idx=1&sn=51d8d865c9848fd59f7763f5fb9ce789&chksm=88662490bf11ad86061ae76ff71a1177eeddab02c38d046eecd0e1ad25dc16f7591f91e9e3b2&scene=21#wechat_redirect">学习 axios 源码整体架构，打造属于自己的请求库</a></p>
<p>注:由于这篇文章时间较久,所以里面对于xhr的取消处理是之前的流程,和现在的最新版本不一致</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController">AbortController</a></p>
<p>针对于fetch的取消请求处理控制器</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E6%BA%90%E7%A0%81/%E3%80%90%E6%BA%90%E7%A0%81%E3%80%91axios-%E5%8F%96%E6%B6%88%E8%AF%B7%E6%B1%82/" data-id="cmf67fxej007fbcfm3w61blco" data-title="axios取消请求原理" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/axios-%E6%BA%90%E7%A0%81/" rel="tag">axios 源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-业务场景/大数据渲染" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:06.987Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/">业务场景</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93/">大数据渲染</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="大数据渲染"><a href="#大数据渲染" class="headerlink" title="大数据渲染"></a>大数据渲染</h1><h2 id="table-分页"><a href="#table-分页" class="headerlink" title="table 分页"></a>table 分页</h2><ul>
<li>每页展示固定的数据</li>
</ul>
<h1></h1>

<h2 id="定时更新-分批渲染"><a href="#定时更新-分批渲染" class="headerlink" title="定时更新,分批渲染"></a>定时更新,分批渲染</h2><p>用<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/64917985?from_voters_page=true"><code>requestAnimationFrame</code></a>或者定时器, 加上<code>DocumentFragment</code>进行每次数据的加载</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">requestAnimationFrame</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> fragment = <span class="keyword">new</span> <span class="title class_">DocumentFragment</span>();</span><br><span class="line">  <span class="keyword">const</span> fruits = [<span class="string">&quot;Apple&quot;</span>, <span class="string">&quot;Orange&quot;</span>, <span class="string">&quot;Banana&quot;</span>, <span class="string">&quot;Melon&quot;</span>];</span><br><span class="line">  fruits.<span class="title function_">forEach</span>(<span class="function">(<span class="params">fruit</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ele = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;p&quot;</span>);</span><br><span class="line">    ele.<span class="property">textContent</span> = fruit;</span><br><span class="line">    fragment.<span class="title function_">appendChild</span>(ele);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(fragment);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>requestAnimationFrame</code>是在<code>style/layout/paint</code>之前触发</li>
</ul>
<h2 id="使用虚拟列表IntersectionObserver"><a href="#使用虚拟列表IntersectionObserver" class="headerlink" title="使用虚拟列表IntersectionObserver"></a>使用虚拟列表<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/11/intersectionobserver_api.html"><code>IntersectionObserver</code></a></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新建一个监听对象</span></span><br><span class="line"><span class="keyword">let</span> io = <span class="keyword">new</span> <span class="title class_">IntersectionObserver</span>(</span><br><span class="line">  <span class="function">(<span class="params">entris</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;IntersectionObserver&quot;</span>, entris);</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">root</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">thresholds</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 开始监听</span></span><br><span class="line">io.<span class="title function_">observe</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;b&quot;</span>));</span><br></pre></td></tr></table></figure>

<ul>
<li><p>当元素初次在页面上显示, 以及之后每次显示和隐藏都会触发回调</p>
</li>
<li><p>IntersectionObserver API 是异步的，不随着目标元素的滚动同步触发。</p>
</li>
<li><p>只有线程空闲下来，才会执行观察器。这意味着，这个观察器的优先级非常低，只在其他任务执行完，浏览器有了空闲才会执行。</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93/" data-id="cmf67fxdr003mbcfmapycctjt" data-title="大数据渲染" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-业务场景/【业务场景】是否外部在调试" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/%E3%80%90%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E3%80%91%E6%98%AF%E5%90%A6%E5%A4%96%E9%83%A8%E5%9C%A8%E8%B0%83%E8%AF%95/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:06.985Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/">业务场景</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/%E3%80%90%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E3%80%91%E6%98%AF%E5%90%A6%E5%A4%96%E9%83%A8%E5%9C%A8%E8%B0%83%E8%AF%95/">是否外部在调试</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><p>键盘</p>
<p>用F12键去判断是否有打开</p>
</li>
<li><p>浏览器内外宽度差</p>
</li>
<li><p>开发者人员工具变量是否为true</p>
</li>
<li><p>console</p>
</li>
<li><p>代码运行时间差</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> time = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"><span class="keyword">const</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">debugger</span></span><br><span class="line"><span class="keyword">const</span> time2 = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"><span class="keyword">const</span> space = time2 - time;</span><br></pre></td></tr></table></figure>
</li>
<li><p>toString</p>
<p>  当鼠标放在函数名上时，会调用函数的toString方法</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isDebug</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">isDebug.<span class="title function_">toString</span>() = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;debuging&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">isDebug</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>caller</p>
<p>  返回函数调用方，监测栈的层数</p>
</li>
<li><p>监测非浏览器的环境</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/%E3%80%90%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E3%80%91%E6%98%AF%E5%90%A6%E5%A4%96%E9%83%A8%E5%9C%A8%E8%B0%83%E8%AF%95/" data-id="cmf67fxdq003gbcfm83ba9fkb" data-title="是否外部在调试" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/" rel="tag">业务场景</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-小程序/【小程序】激励广告" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91%E6%BF%80%E5%8A%B1%E5%B9%BF%E5%91%8A/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:06.953Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91%E6%BF%80%E5%8A%B1%E5%B9%BF%E5%91%8A/">【小程序】上传和下载文件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="接入激励广告"><a href="#接入激励广告" class="headerlink" title="接入激励广告"></a>接入激励广告</h2><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/ad/rewarded-video-ad.html">激励视频广告</a></p>
<p>小程序的激励广告可以使得小程序增加一个收入来源，在小程序管理后台【流量主】-》【广告管理】-》【新建广告位】，可以选择创建激励视频、插屏、视频贴片和原生模板广告，可以设置广告时长（6-15 秒、6-30 秒、6-60 秒、60-不限）</p>
<p>创建完成后，会有个广告 id，这个 id 可以作为前端加载初始化的参数。一个小程序可以有多个广告 id，因此可以用不同的广告 id 来去区分不同场景</p>
<h3 id="载入"><a href="#载入" class="headerlink" title="载入"></a>载入</h3><p>小程序官方文件推荐在<code>onLoad</code>生命周期中加载广告组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewardedVideoAdRef = wx.<span class="title function_">createRewardedVideoAd</span>(&#123; <span class="attr">adUnitId</span>: <span class="string">&quot;广告id&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>在其加载完成后，如果在未加载完成的情况下，是无法调起广告的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听广告加载事件，加载完成后隐藏加载提示</span></span><br><span class="line">rewardedVideoAdRef.<span class="title function_">onLoad</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">resolve</span>(<span class="string">&quot;onload&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 监听广告错误事件，隐藏加载提示并打印错误信息</span></span><br><span class="line">rewardedVideoAdRef.<span class="title function_">onError</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">reject</span>(<span class="string">&quot;onerror&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h3><p>广告加载完成会有一段时间，调用<code>show</code>到实际展示时也会有一段时间，建议给个 loading</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">uni.<span class="title function_">showLoading</span>(&#123; <span class="attr">title</span>: <span class="string">&quot;加载中&quot;</span> &#125;);</span><br><span class="line">rewardedVideoAdRef</span><br><span class="line">  .<span class="title function_">show</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 可以拿到广告的打开时间</span></span><br><span class="line">    showTime = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">    uni.<span class="title function_">hideLoading</span>();</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    uni.<span class="title function_">hideLoading</span>();</span><br><span class="line">    failCb &amp;&amp; <span class="title function_">failCb</span>(err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="监听关闭"><a href="#监听关闭" class="headerlink" title="监听关闭"></a>监听关闭</h3><p>小程序提供了<code>onClose</code>事件，在用户主动点击关闭按钮时触发，即使广告已经结束的情况下，不会主动关闭，需要用户手动操作</p>
<p>其中的<code>isEnded</code>标识这次关闭事件是否完整观看，如果完整观看则返回 true，否则返回 false</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rewardedVideoAdRef?.<span class="title function_">onClose</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> closeTime = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">  <span class="comment">//   向后端发送广告数据</span></span><br><span class="line">  <span class="keyword">if</span> (isAutoUp) &#123;</span><br><span class="line">    <span class="title function_">reportAdData</span>(&#123;</span><br><span class="line">      <span class="attr">view_time</span>: showTime,</span><br><span class="line">      <span class="attr">finish_time</span>: closeTime,</span><br><span class="line">      <span class="attr">finished</span>: res.<span class="property">isEnded</span>,</span><br><span class="line">      <span class="attr">id</span>: videoAdData?.<span class="property">id</span>,</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      successCb &amp;&amp; <span class="title function_">successCb</span>(res.<span class="property">isEnded</span>);</span><br><span class="line">      <span class="title function_">resolve</span>(res.<span class="property">isEnded</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    successCb &amp;&amp; <span class="title function_">successCb</span>(res.<span class="property">isEnded</span>);</span><br><span class="line">    <span class="title function_">resolve</span>(res.<span class="property">isEnded</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="全部代码"><a href="#全部代码" class="headerlink" title="全部代码"></a>全部代码</h3><p>将激励视频相关的全部抽离到一个 hooks 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 钩子函数，用于管理微信激励视频广告的生命周期</span></span><br><span class="line"><span class="comment"> * 包括广告的创建和显示</span></span><br><span class="line"><span class="comment"> * 该函数返回两个函数：createAd用于创建广告，showAd用于显示广告</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">useRewardedVideoAd</span> = (<span class="params">failCb</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 初始化微信激励视频广告对象为null</span></span><br><span class="line">  <span class="keyword">let</span> rewardedVideoAdRef = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 广告是否加载失败</span></span><br><span class="line">  <span class="keyword">let</span> onLoadVideoAdFail = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> showTime = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建微信激励视频广告的函数</span></span><br><span class="line"><span class="comment">   * 该函数会检查是否存在wx.createRewardedVideoAd方法，如果存在则创建广告</span></span><br><span class="line"><span class="comment">   * 并监听广告的加载、错误和关闭事件</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onCreateAd</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (wx.<span class="property">createRewardedVideoAd</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> loaded = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">let</span> timer = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">const</span> maxLoading = <span class="number">20000</span>;</span><br><span class="line">        <span class="comment">// 创建微信激励视频广告实例</span></span><br><span class="line">        rewardedVideoAdRef = wx.<span class="title function_">createRewardedVideoAd</span>(&#123; <span class="attr">adUnitId</span>: <span class="string">&quot;广告id&quot;</span> &#125;);</span><br><span class="line">        <span class="comment">// 监听广告加载事件，加载完成后隐藏加载提示</span></span><br><span class="line">        rewardedVideoAdRef.<span class="title function_">onLoad</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          uni.<span class="title function_">hideLoading</span>();</span><br><span class="line">          loaded = <span class="literal">true</span>;</span><br><span class="line">          <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">trace</span>();</span><br><span class="line">          <span class="title function_">resolve</span>(<span class="string">&quot;onload&quot;</span>);</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;rewardedVideoAdRef---onLoad event emit,&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 监听广告错误事件，隐藏加载提示并打印错误信息</span></span><br><span class="line">        rewardedVideoAdRef.<span class="title function_">onError</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          uni.<span class="title function_">hideLoading</span>();</span><br><span class="line">          loaded = <span class="literal">true</span>;</span><br><span class="line">          <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">          onLoadVideoAdFail = <span class="literal">true</span>;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;rewardedVideoAdRef---onError event emit&quot;</span>, err);</span><br><span class="line">          <span class="title function_">reject</span>(<span class="string">&quot;onerror&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 这个是为了防止无法进入onload或者onerror的回调</span></span><br><span class="line">        timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          onLoadVideoAdFail = <span class="literal">true</span>;</span><br><span class="line">          <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">          <span class="keyword">if</span> (!loaded) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&quot;onerror&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, maxLoading);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onCloseAd</span> = (<span class="params">isAutoUp = <span class="literal">true</span>, extraParams = &#123;&#125;, successCb</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 监听广告关闭事件，根据用户是否完整观看视频执行不同逻辑</span></span><br><span class="line"><span class="comment">       * 如果用户完整观看视频，打印相应信息</span></span><br><span class="line"><span class="comment">       * 否则，打印用户未完整观看视频的信息</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      rewardedVideoAdRef?.<span class="title function_">onClose</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> closeTime = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;rewardedVideoAdRef---onClose event emit&quot;</span>, isAutoUp, res);</span><br><span class="line">        <span class="keyword">if</span> (isAutoUp) &#123;</span><br><span class="line">          <span class="title function_">reportAdData</span>(&#123;</span><br><span class="line">            <span class="attr">view_time</span>: showTime,</span><br><span class="line">            <span class="attr">finish_time</span>: closeTime,</span><br><span class="line">            <span class="attr">finished</span>: res.<span class="property">isEnded</span>,</span><br><span class="line">            <span class="attr">id</span>: <span class="string">&quot;广告id&quot;</span>,</span><br><span class="line">            ...extraParams,</span><br><span class="line">          &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            successCb &amp;&amp; <span class="title function_">successCb</span>(res.<span class="property">isEnded</span>);</span><br><span class="line">            <span class="title function_">resolve</span>(res.<span class="property">isEnded</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          successCb &amp;&amp; <span class="title function_">successCb</span>(res.<span class="property">isEnded</span>);</span><br><span class="line">          <span class="title function_">resolve</span>(res.<span class="property">isEnded</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 显示微信激励视频广告的函数</span></span><br><span class="line"><span class="comment">   * 尝试显示广告，如果显示失败则重新创建并尝试显示</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onShowAd</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (rewardedVideoAdRef) &#123;</span><br><span class="line">      uni.<span class="title function_">showLoading</span>(&#123; <span class="attr">title</span>: <span class="string">&quot;加载中&quot;</span> &#125;);</span><br><span class="line">      <span class="comment">// 尝试显示广告，如果显示失败则重新创建广告并再次尝试显示</span></span><br><span class="line">      rewardedVideoAdRef</span><br><span class="line">        .<span class="title function_">show</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          showTime = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">          uni.<span class="title function_">hideLoading</span>();</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onShowAd---catch&quot;</span>, err);</span><br><span class="line">          uni.<span class="title function_">hideLoading</span>();</span><br><span class="line">          failCb &amp;&amp; <span class="title function_">failCb</span>(err);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onLoadAd</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">onCreateAd</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(res);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回创建和显示广告的函数，供外部调用</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    onCreateAd,</span><br><span class="line">    onShowAd,</span><br><span class="line">    rewardedVideoAdRef,</span><br><span class="line">    onCloseAd,</span><br><span class="line">    onLoadVideoAdFail,</span><br><span class="line">    onLoadAd,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>使用方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 视频关闭回调</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onClose</span> = (<span class="params">isEnab</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isEnab) &#123;</span><br><span class="line">    uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;增加权益失败&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  uni.<span class="title function_">navigateBack</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onCreateAd</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">onShowAd</span>();</span><br><span class="line">    <span class="title function_">onCloseAd</span>(<span class="literal">true</span>, &#123;&#125;, <span class="function">(<span class="params">isEnab</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">onClose</span>(isEnab);</span><br><span class="line">    &#125;);</span><br><span class="line">    isShowed = <span class="literal">true</span>;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    uni.<span class="title function_">hideLoading</span>();</span><br><span class="line">    uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;视频获取失败&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91%E6%BF%80%E5%8A%B1%E5%B9%BF%E5%91%8A/" data-id="cmf67fxe0004ubcfm1v7l5qau" data-title="【小程序】上传和下载文件" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-小程序/【小程序】自实现md预览+文字打字机效果" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91%E8%87%AA%E5%AE%9E%E7%8E%B0md%E9%A2%84%E8%A7%88+%E6%96%87%E5%AD%97%E6%89%93%E5%AD%97%E6%9C%BA%E6%95%88%E6%9E%9C/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:06.953Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91%E8%87%AA%E5%AE%9E%E7%8E%B0md%E9%A2%84%E8%A7%88+%E6%96%87%E5%AD%97%E6%89%93%E5%AD%97%E6%9C%BA%E6%95%88%E6%9E%9C/">【小程序】自实现md预览+文字打字机效果</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="实现预览效果"><a href="#实现预览效果" class="headerlink" title="实现预览效果"></a>实现预览效果</h2><p>由于后端返回的是 md 格式的文本，由于文本中的标题、列表会和&#x2F;&#x2F;n 同时出现，因此使用<code>marked</code>会无法正确识别标题、列表等语法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 统一处理行内格式：加粗、斜体、链接、行内代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parseInlineMarkdown</span>(<span class="params">text</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> text</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/\*\*(.*?)\*\*/g</span>, <span class="string">&quot;&lt;strong&gt;$1&lt;/strong&gt;&quot;</span>) <span class="comment">// 加粗</span></span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/\*(.*?)\*/g</span>, <span class="string">&quot;&lt;em&gt;$1&lt;/em&gt;&quot;</span>) <span class="comment">// 斜体 *</span></span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/_(.*?)_/g</span>, <span class="string">&quot;&lt;em&gt;$1&lt;/em&gt;&quot;</span>) <span class="comment">// 斜体 _</span></span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/`(.*?)`/g</span>, <span class="string">&quot;&lt;code&gt;$1&lt;/code&gt;&quot;</span>) <span class="comment">// 行内代码</span></span><br><span class="line">    .<span class="title function_">replace</span>(</span><br><span class="line">      <span class="regexp">/$$([^$$]+)$$$([^$$]+)$$/g</span>,</span><br><span class="line">      <span class="string">&#x27;&lt;a href=&quot;$2&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;&gt;$1&lt;/a&gt;&#x27;</span></span><br><span class="line">    ); <span class="comment">// 链接</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">markdownToHTML</span>(<span class="params">markdown</span>) &#123;</span><br><span class="line">  <span class="comment">// 处理转义换行符并分割文本</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">text</span>: string = (markdown.<span class="title function_">replace</span>(<span class="regexp">/&amp;@#\$&amp;$/</span>, <span class="string">&quot;&quot;</span>) || <span class="string">&quot;&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/\\\\n/g</span>, <span class="string">&quot;\\n&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/\\n/g</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/\s\\S/g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(markdown, text);</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">lines</span>: string[] = text.<span class="title function_">split</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">html</span>: string[] = [];</span><br><span class="line">  <span class="keyword">let</span> inList = <span class="literal">false</span>; <span class="comment">// 跟踪列表状态</span></span><br><span class="line">  <span class="keyword">let</span> inCodeBlock = <span class="literal">false</span>; <span class="comment">// 跟踪是否在代码块中</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">codeBlockContent</span>: string[] = []; <span class="comment">// 暂存代码块内容</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> line <span class="keyword">of</span> lines) &#123;</span><br><span class="line">    <span class="keyword">const</span> trimmedLine = line.<span class="title function_">replace</span>(<span class="regexp">/\s\\S/g</span>, <span class="string">&quot; &quot;</span>).<span class="title function_">trim</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否是代码块开始或结束</span></span><br><span class="line">    <span class="keyword">if</span> (trimmedLine.<span class="title function_">startsWith</span>(<span class="string">&quot;```&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (inCodeBlock) &#123;</span><br><span class="line">        <span class="comment">// 如果已经在代码块中，表示代码块结束</span></span><br><span class="line">        html.<span class="title function_">push</span>(</span><br><span class="line">          <span class="string">&quot;&lt;pre style=&#x27; white-space: pre-wrap;word-wrap: break-word;overflow-x: auto;max-width: 100%;&#x27;&gt;&lt;code&gt;&quot;</span> +</span><br><span class="line">            codeBlockContent.<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>) +</span><br><span class="line">            <span class="string">&quot;&lt;/code&gt;&lt;/pre&gt;&quot;</span></span><br><span class="line">        );</span><br><span class="line">        codeBlockContent = []; <span class="comment">// 清空暂存内容</span></span><br><span class="line">        inCodeBlock = <span class="literal">false</span>; <span class="comment">// 退出代码块模式</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果不在代码块中，表示代码块开始</span></span><br><span class="line">        inCodeBlock = <span class="literal">true</span>; <span class="comment">// 进入代码块模式</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">continue</span>; <span class="comment">// 跳过后续逻辑，直接处理下一行</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果在代码块中，收集代码块内容</span></span><br><span class="line">    <span class="keyword">if</span> (inCodeBlock) &#123;</span><br><span class="line">      codeBlockContent.<span class="title function_">push</span>(line);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 匹配 # 到 ###### 并提取层级</span></span><br><span class="line">    <span class="keyword">const</span> headingMatch = trimmedLine.<span class="title function_">match</span>(<span class="regexp">/^(\#&#123;1,6&#125;)\s+(.+)$/</span>);</span><br><span class="line">    <span class="keyword">if</span> (headingMatch) &#123;</span><br><span class="line">      <span class="comment">// 关闭前一个列表</span></span><br><span class="line">      <span class="keyword">if</span> (inList) &#123;</span><br><span class="line">        html.<span class="title function_">push</span>(<span class="string">&quot;&lt;/ul&gt;&quot;</span>);</span><br><span class="line">        inList = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> level = headingMatch[<span class="number">1</span>].<span class="property">length</span>; <span class="comment">// 获取标题级别 1-6</span></span><br><span class="line">      <span class="keyword">const</span> content = headingMatch[<span class="number">2</span>].<span class="title function_">replace</span>(</span><br><span class="line">        <span class="regexp">/\*\*(.*?)\*\*/g</span>,</span><br><span class="line">        <span class="string">&quot;&lt;strong&gt;$1&lt;/strong&gt;&quot;</span></span><br><span class="line">      ); <span class="comment">// 处理加粗</span></span><br><span class="line"></span><br><span class="line">      html.<span class="title function_">push</span>(<span class="string">`&lt;h<span class="subst">$&#123;level&#125;</span>&gt;<span class="subst">$&#123;content&#125;</span>&lt;/h<span class="subst">$&#123;level&#125;</span>&gt;`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理横线 ---</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (trimmedLine === <span class="string">&quot;---&quot;</span>) &#123;</span><br><span class="line">      html.<span class="title function_">push</span>(<span class="string">&quot;&lt;hr&gt;&quot;</span>);</span><br><span class="line">      <span class="keyword">continue</span>; <span class="comment">// 跳过后续逻辑，直接处理下一行</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理列表项 (-)</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^-/</span>.<span class="title function_">test</span>(trimmedLine)) &#123;</span><br><span class="line">      <span class="comment">// 首次进入列表时添加&lt;ul&gt;</span></span><br><span class="line">      <span class="keyword">if</span> (!inList) &#123;</span><br><span class="line">        html.<span class="title function_">push</span>(<span class="string">&quot;&lt;ul&gt;&quot;</span>);</span><br><span class="line">        inList = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 处理列表项内容并转换加粗</span></span><br><span class="line">      <span class="keyword">let</span> content = trimmedLine</span><br><span class="line">        .<span class="title function_">replace</span>(<span class="regexp">/^-\s+/</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .<span class="title function_">replace</span>(<span class="regexp">/\*\*(.*?)\*\*/g</span>, <span class="string">&quot;&lt;strong&gt;$1&lt;/strong&gt;&quot;</span>);</span><br><span class="line">      content = <span class="title function_">parseInlineMarkdown</span>(content);</span><br><span class="line">      html.<span class="title function_">push</span>(<span class="string">`&lt;li&gt;<span class="subst">$&#123;content&#125;</span>&lt;/li&gt;`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理普通文本</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 关闭已存在的列表</span></span><br><span class="line">      <span class="keyword">if</span> (inList) &#123;</span><br><span class="line">        html.<span class="title function_">push</span>(<span class="string">&quot;&lt;/ul&gt;&quot;</span>);</span><br><span class="line">        inList = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 非空行转为段落</span></span><br><span class="line">      <span class="keyword">if</span> (trimmedLine !== <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> content = <span class="title function_">parseInlineMarkdown</span>(trimmedLine);</span><br><span class="line">        <span class="keyword">if</span> (content === <span class="string">&quot;&lt;br /&gt;&quot;</span>) &#123;</span><br><span class="line">          html.<span class="title function_">push</span>(<span class="string">&quot;&lt;br /&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          html.<span class="title function_">push</span>(<span class="string">`&lt;p&gt;<span class="subst">$&#123;content&#125;</span>&lt;/p&gt;`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关闭最后一个列表</span></span><br><span class="line">  <span class="keyword">if</span> (inList) html.<span class="title function_">push</span>(<span class="string">&quot;&lt;/ul&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> html.<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>支持常用的几种语法：</p>
<ul>
<li>标题</li>
<li>列表</li>
<li>代码块（行内&#x2F;块状</li>
<li>加粗、斜体</li>
</ul>
<p>其他的可以按照需求自行扩展</p>
<h2 id="实现打字机效果"><a href="#实现打字机效果" class="headerlink" title="实现打字机效果"></a>实现打字机效果</h2><h3 id="将-html-转为可遍历的节点数组"><a href="#将-html-转为可遍历的节点数组" class="headerlink" title="将 html 转为可遍历的节点数组"></a>将 html 转为可遍历的节点数组</h3><p>上一步是把 md 文本字符串转为 html 字符串，但需要实现打字机效果的话，需要将 html 转为可遍历的节点数组，以实现打字机效果。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将HTML转换为可遍历的节点数组</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">htmlToNodes</span> = (<span class="params">html: string</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> tagRegex = <span class="regexp">/(&lt;\/?[^&gt;]+&gt;)/g</span>;</span><br><span class="line">  <span class="keyword">return</span> html</span><br><span class="line">    .<span class="title function_">split</span>(tagRegex)</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function">(<span class="params">chunk</span>) =&gt;</span> chunk.<span class="title function_">trim</span>())</span><br><span class="line">    .<span class="title function_">flatMap</span>(<span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (chunk.<span class="title function_">startsWith</span>(<span class="string">&quot;&lt;&quot;</span>)) <span class="keyword">return</span> [chunk];</span><br><span class="line">      <span class="keyword">return</span> chunk.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">map</span>(<span class="function">(<span class="params">char</span>) =&gt;</span> (char === <span class="string">&quot; &quot;</span> ? <span class="string">&quot;&amp;nbsp;&quot;</span> : char));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="打字机效果"><a href="#打字机效果" class="headerlink" title="打字机效果"></a>打字机效果</h3><p>使用定时器去定时添加文字</p>
<p>父组件调用<code>stopTimer</code>可以停止文字继续显示</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [currentIndex, setCurrentIndex] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// displayContent是需要显示的html节点</span></span><br><span class="line"><span class="keyword">const</span> [displayContent, setDisplayContent] = useState&lt;string[]&gt;([]);</span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (currentIndex &lt; nodes.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="title function_">setDisplayContent</span>(<span class="function">(<span class="params">prev</span>) =&gt;</span> [...prev, nodes[currentIndex]]);</span><br><span class="line">      <span class="title function_">setCurrentIndex</span>(<span class="function">(<span class="params">prev</span>) =&gt;</span> prev + <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">      timer = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (onStop &amp;&amp; nodes.<span class="property">length</span>) <span class="title function_">onStop</span>(); <span class="comment">// 触发 onStop 回调</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="number">50</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (timer) <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, [nodes, currentIndex]);</span><br><span class="line"></span><br><span class="line"><span class="title function_">useImperativeHandle</span>(ref, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">stopTimer</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (timer) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RichText</span> <span class="attr">className</span>=<span class="string">&quot;break-all leading-[56rpx]&quot;</span> <span class="attr">nodes</span>=<span class="string">&#123;displayContent.join(</span>&quot;&quot;)&#125;</span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">View</span>, <span class="title class_">RichText</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tarojs/components&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; markdownToHTML &#125; <span class="keyword">from</span> <span class="string">&quot;@/hooks/useMd&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">FC</span>, <span class="title class_">PropsWithChildren</span>, useState, useEffect, useMemo, useRef, useImperativeHandle, forwardRef &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line">type <span class="title class_">TAIAnswerProps</span> = &#123;</span><br><span class="line">  <span class="attr">text</span>: string;</span><br><span class="line">  onStop?: <span class="function">() =&gt;</span> <span class="keyword">void</span>;       <span class="comment">// 新增 prop：定时器停止时通知父组件</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 ref 暴露方法给父组件</span></span><br><span class="line"><span class="keyword">export</span> type <span class="title class_">AIAnswerRef</span> = &#123;</span><br><span class="line">  <span class="attr">stopTimer</span>: <span class="function">() =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确使用 forwardRef 并定义 ref 类型</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AIAnswer</span>: <span class="variable constant_">FC</span>&lt;<span class="title class_">PropsWithChildren</span>&lt;<span class="title class_">TAIAnswerProps</span>&gt;&gt; &amp; &#123; ref?: <span class="title class_">React</span>.<span class="property">Ref</span>&lt;<span class="title class_">AIAnswerRef</span>&gt; &#125; = forwardRef&lt;</span><br><span class="line">  <span class="title class_">AIAnswerRef</span>,</span><br><span class="line">  <span class="title class_">PropsWithChildren</span>&lt;<span class="title class_">TAIAnswerProps</span>&gt;</span><br><span class="line">&gt;(<span class="function">(<span class="params">&#123; text, onStop &#125;, ref</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [displayContent, setDisplayContent] = useState&lt;string[]&gt;([]);</span><br><span class="line">  <span class="keyword">const</span> [currentIndex, setCurrentIndex] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [htmlStr, setHtmlStr] = <span class="title function_">useState</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将HTML转换为可遍历的节点数组</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">htmlToNodes</span> = (<span class="params">html: string</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> tagRegex = <span class="regexp">/(&lt;\/?[^&gt;]+&gt;)/g</span>;</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line">      .<span class="title function_">split</span>(tagRegex)</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function">(<span class="params">chunk</span>) =&gt;</span> chunk.<span class="title function_">trim</span>())</span><br><span class="line">      .<span class="title function_">flatMap</span>(<span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (chunk.<span class="title function_">startsWith</span>(<span class="string">&quot;&lt;&quot;</span>)) <span class="keyword">return</span> [chunk];</span><br><span class="line">        <span class="keyword">return</span> chunk.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">map</span>(<span class="function">(<span class="params">char</span>) =&gt;</span> (char === <span class="string">&quot; &quot;</span> ? <span class="string">&quot;&amp;nbsp;&quot;</span> : char));</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用useMemo缓存节点数组</span></span><br><span class="line">  <span class="keyword">const</span> nodes = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> <span class="title function_">htmlToNodes</span>(htmlStr), [htmlStr]);</span><br><span class="line">  <span class="keyword">let</span> timer = <span class="literal">null</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;nodes&quot;</span>, nodes)</span><br><span class="line">    timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (currentIndex &lt; nodes.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="title function_">setDisplayContent</span>(<span class="function">(<span class="params">prev</span>) =&gt;</span> [...prev, nodes[currentIndex]]);</span><br><span class="line">        <span class="title function_">setCurrentIndex</span>(<span class="function">(<span class="params">prev</span>) =&gt;</span> prev + <span class="number">1</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">        timer = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (onStop &amp;&amp; nodes.<span class="property">length</span>) <span class="title function_">onStop</span>(); <span class="comment">// 触发 onStop 回调</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (timer) <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [nodes, currentIndex]);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    text &amp;&amp; <span class="title function_">setHtmlStr</span>(<span class="title function_">markdownToHTML</span>(text));</span><br><span class="line">  &#125;, [text]);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useImperativeHandle</span>(ref, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">stopTimer</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (timer) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;));</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&quot;flex justify-start pt-[20rpx]&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;text ? (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&quot;inline-block py-[15rpx] text-[28rpx]&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">RichText</span> <span class="attr">className</span>=<span class="string">&quot;break-all leading-[56rpx]&quot;</span> <span class="attr">nodes</span>=<span class="string">&#123;displayContent.join(</span>&quot;&quot;)&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ) : (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&quot;inline-block py-[15rpx] text-[28rpx]&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            正在生成...</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        )&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">AIAnswer</span>;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91%E8%87%AA%E5%AE%9E%E7%8E%B0md%E9%A2%84%E8%A7%88+%E6%96%87%E5%AD%97%E6%89%93%E5%AD%97%E6%9C%BA%E6%95%88%E6%9E%9C/" data-id="cmf67fxe1004ybcfmbi254qor" data-title="【小程序】自实现md预览+文字打字机效果" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-小程序/【小程序】uniapp发布插件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91uniapp%E5%8F%91%E5%B8%83%E6%8F%92%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:06.947Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91uniapp%E5%8F%91%E5%B8%83%E6%8F%92%E4%BB%B6/">【小程序】uniapp发布插件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="【小程序】uniapp发布插件"><a href="#【小程序】uniapp发布插件" class="headerlink" title="【小程序】uniapp发布插件"></a>【小程序】uniapp发布插件</h1><p><a target="_blank" rel="noopener" href="https://uniapp.dcloud.net.cn/plugin/uni_modules.html#%E4%BD%BF%E7%94%A8-uni-modules-%E6%8F%92%E4%BB%B6">uni-modules-插件</a></p>
<h2 id="新建发布uni-modules插件"><a href="#新建发布uni-modules插件" class="headerlink" title="新建发布uni_modules插件"></a>新建发布uni_modules插件</h2><ul>
<li><p>在<code>uni_modules</code>右键，选择新建一个<code>uni_modules插件</code></p>
<p>此时会生成一个插件模板代码</p>
</li>
<li><p>写好对应的文件后，在<code>插件目录右键</code>，选择<code>发布到插件市场</code></p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCBR6uq"><img src="https://s1.ax1x.com/2023/07/01/pCBR6uq.png" alt="pCBR6uq.png"></a></p>
<p>填写好对应的信息后，直接进行保存即可</p>
</li>
<li><p>发布好后，即可在uniapp插件市场中进行下载</p>
</li>
</ul>
<h2 id="更新插件"><a href="#更新插件" class="headerlink" title="更新插件"></a>更新插件</h2><ul>
<li><p>更新好具体的内容后，右键选择<code>发布到插件市场</code></p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCBWUMR"><img src="https://s1.ax1x.com/2023/07/01/pCBWUMR.png" alt="pCBWUMR.png"></a></p>
</li>
</ul>
<p>更新即可</p>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ul>
<li><p>发布和导入是同一个项目</p>
<p>项目里面如果又导入了这个插件，那么在uni_modules下导入的插件会被覆盖</p>
</li>
<li><p>发布的包必须包含的文件</p>
<ul>
<li><p><code>components/插件名/插件名.vue</code></p>
<p>如果没有这个文件，那么在发布时会报错</p>
</li>
<li><p><code>package.json</code></p>
<p>用于配置发布插件的一些信息</p>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91uniapp%E5%8F%91%E5%B8%83%E6%8F%92%E4%BB%B6/" data-id="cmf67fxdw004gbcfm85n2gadi" data-title="【小程序】uniapp发布插件" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-小程序/【小程序】uniapp引入野火对话" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91uniapp%E5%BC%95%E5%85%A5%E9%87%8E%E7%81%AB%E5%AF%B9%E8%AF%9D/" class="article-date">
  <time class="dt-published" datetime="2025-08-14T03:18:06.947Z" itemprop="datePublished">2025-08-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91uniapp%E5%BC%95%E5%85%A5%E9%87%8E%E7%81%AB%E5%AF%B9%E8%AF%9D/">【小程序】uniapp引入野火对话</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://docs.wildfirechat.cn/web/integration.html">官方文档</a></p>
<h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><h3 id="引入-sdk"><a href="#引入-sdk" class="headerlink" title="引入 sdk"></a>引入 sdk</h3><ul>
<li><p>下载<a target="_blank" rel="noopener" href="https://github.com/wildfirechat/wx-chat">wx-chat</a>项目包</p>
</li>
<li><p>把<code>wfc/proto/proto.min.js</code>替换为自己的文件，然后再把<code>wfc</code>文件目录引入到自己的项目下，随便放在哪个目录</p>
</li>
<li><p>将示例项目的<code>config.js</code>放在自己项目下</p>
</li>
</ul>
<h4 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h4><p>引入后，wfc 中报错<code>btoa</code>有问题</p>
<p>查看到 btoa 是引用的<code>util/base64.min.js</code>，估计是打包的兼容性问题</p>
<p>但这个文件内容很少，因此重写一下<code>util/base64.min.js</code>的两个方法即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> btoa = <span class="keyword">function</span> (<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(str.<span class="property">length</span>);</span><br><span class="line">  <span class="keyword">const</span> dataView = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buffer);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    dataView[i] = str.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 使用 uni-app 或微信小程序的 base64 编码方法</span></span><br><span class="line">  <span class="keyword">return</span> uni.<span class="title function_">arrayBufferToBase64</span>(buffer); <span class="comment">// uni-app 请用 uni.arrayBufferToBase64</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> atob = <span class="keyword">function</span> (<span class="params">base64</span>) &#123;</span><br><span class="line">  <span class="comment">// 使用小程序 base64 转 ArrayBuffer</span></span><br><span class="line">  <span class="keyword">const</span> arrayBuffer = uni.<span class="title function_">base64ToArrayBuffer</span>(base64); <span class="comment">// uni-app 请用 uni.base64ToArrayBuffer</span></span><br><span class="line">  <span class="keyword">const</span> uint8Array = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(arrayBuffer);</span><br><span class="line">  <span class="keyword">let</span> str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; uint8Array.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    str += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(uint8Array[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> str;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><ul>
<li>在<code>app.vue</code>的<code>onLaunch</code>中，进行 wfc 的初始化</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wfc <span class="keyword">from</span> <span class="string">&quot;@/wfc/client/wfc&quot;</span>;</span><br><span class="line"><span class="comment">// 初始化 wfc</span></span><br><span class="line">wfc.<span class="title function_">init</span>();</span><br><span class="line"><span class="comment">// 获取到当前用户的clientid，后续链接会用的</span></span><br><span class="line"><span class="keyword">const</span> clientId = wfc.<span class="title function_">getClientId</span>(<span class="string">&quot;wx&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;clientId&quot;</span>, clientId);</span><br><span class="line"><span class="title class_">Store</span>.<span class="property">chatStore</span>.<span class="title function_">setClientId</span>(clientId);</span><br><span class="line"><span class="keyword">return</span> clientId;</span><br></pre></td></tr></table></figure>

<ul>
<li>connect 链接</li>
</ul>
<p>拿到当前用户的 userid 和 token，连接到 wfc</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfc.<span class="title function_">connect</span>(userId, token);</span><br></pre></td></tr></table></figure>

<h2 id="对话列表"><a href="#对话列表" class="headerlink" title="对话列表"></a>对话列表</h2><p>其实 wx-chat 这个项目已经提供的很全面了，只是需要把小程序代码转为 uniapp 的代码，这步可以交由 ai 帮忙完成</p>
<p>因此这里只把所有代码贴出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onLoad, onShow &#125; <span class="keyword">from</span> <span class="string">&#x27;@dcloudio/uni-app&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; onMounted, onUnmounted, ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">EventType</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/client/wfcEvent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ConnectionStatus</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/client/connectionStatus&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MessageConfig</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/client/messageConfig&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">PersistFlag</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/persistFlag&#x27;</span></span><br><span class="line"><span class="keyword">import</span> wfc <span class="keyword">from</span> <span class="string">&#x27;@/wfc/client/wfc&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; timeFormat &#125; <span class="keyword">from</span> <span class="string">&#x27;@/wfc/util/time&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Config</span> <span class="keyword">from</span> <span class="string">&#x27;@/config&#x27;</span></span><br><span class="line"><span class="keyword">import</span> sha1 <span class="keyword">from</span> <span class="string">&#x27;js-sha1&#x27;</span></span><br><span class="line"></span><br><span class="line">interface <span class="title class_">ConversationUI</span> &#123;</span><br><span class="line">  <span class="attr">conversation</span>: any</span><br><span class="line">  <span class="attr">ui</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: string</span><br><span class="line">    <span class="attr">portrait</span>: string</span><br><span class="line">    <span class="attr">lastMsgContent</span>: string</span><br><span class="line">    <span class="attr">unread</span>: number</span><br><span class="line">    <span class="attr">time</span>: string</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> conversations = ref&lt;<span class="title class_">ConversationUI</span>[]&gt;([])</span><br><span class="line"><span class="keyword">const</span> isLoading = <span class="title function_">ref</span>(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件处理函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onConnnectionStatusChange</span> = (<span class="params">status: number</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;connectionStatus&#x27;</span>, status)</span><br><span class="line">  <span class="keyword">if</span> (status === <span class="title class_">ConnectionStatus</span>.<span class="property">ConnectionStatusConnected</span>) &#123;</span><br><span class="line">    <span class="title function_">showConversationList</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> logoutStatuses = [</span><br><span class="line">    <span class="title class_">ConnectionStatus</span>.<span class="property">ConnectionStatusLogout</span>,</span><br><span class="line">    <span class="title class_">ConnectionStatus</span>.<span class="property">ConnectionStatusRejected</span>,</span><br><span class="line">    <span class="title class_">ConnectionStatus</span>.<span class="property">ConnectionStatusKickedOff</span>,</span><br><span class="line">    <span class="title class_">ConnectionStatus</span>.<span class="property">ConnectionStatusTokenIncorrect</span>,</span><br><span class="line">    <span class="title class_">ConnectionStatus</span>.<span class="property">ConnectionStatusSecretKeyMismatch</span>,</span><br><span class="line">    <span class="title class_">ConnectionStatus</span>.<span class="property">ConnectionStatusServerDown</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (logoutStatuses.<span class="title function_">includes</span>(status)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;reLaunch login page, connectionStatus&#x27;</span>, status)</span><br><span class="line">    uni.<span class="title function_">clearStorageSync</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onUserInfosUpdate</span> = (<span class="params"></span>) =&gt; <span class="title function_">showConversationList</span>()</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onGroupInfosUpdate</span> = (<span class="params"></span>) =&gt; <span class="title function_">showConversationList</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onReceiveMessage</span> = (<span class="params">msg: any</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;receive msg&#x27;</span>, msg)</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="title class_">MessageConfig</span>.<span class="title function_">getMessageContentPersitFlag</span>(msg.<span class="property">content</span>.<span class="property">type</span>) === <span class="title class_">PersistFlag</span>.<span class="property">Persist_And_Count</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">showConversationList</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onSettingUpdate</span> = (<span class="params"></span>) =&gt; <span class="title function_">showConversationList</span>()</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onConversationInfoUpdate</span> = (<span class="params"></span>) =&gt; <span class="title function_">showConversationList</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> calculateSign = (<span class="attr">nonce</span>: string, <span class="attr">secretKey</span>: string): &#123; <span class="attr">sign</span>: string; <span class="attr">timestamp</span>: string &#125; =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> timestamp = <span class="title class_">Date</span>.<span class="title function_">now</span>().<span class="title function_">toString</span>()</span><br><span class="line">  <span class="keyword">const</span> data = <span class="string">`<span class="subst">$&#123;nonce&#125;</span>|<span class="subst">$&#123;secretKey&#125;</span>|<span class="subst">$&#123;timestamp&#125;</span>`</span></span><br><span class="line">  <span class="keyword">const</span> sign = <span class="title function_">sha1</span>(data)</span><br><span class="line">  <span class="keyword">return</span> &#123; sign, timestamp &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">showConversationList</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> list = wfc.<span class="title function_">getConversationList</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>], [<span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line">  <span class="keyword">const</span> clUi = list.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    item.<span class="property">ui</span> = &#123;</span><br><span class="line">      <span class="attr">title</span>: item.<span class="title function_">title</span>(),</span><br><span class="line">      <span class="attr">portrait</span>: item.<span class="title function_">portrait</span>() || <span class="title class_">Config</span>.<span class="property">DEFAULT_USER_PORTRAIT</span>,</span><br><span class="line">      <span class="attr">lastMsgContent</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">unread</span>: item.<span class="property">unreadCount</span>?.<span class="property">unread</span> || <span class="number">0</span>,</span><br><span class="line">      <span class="attr">time</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (item.<span class="property">lastMessage</span> &amp;&amp; item.<span class="property">lastMessage</span>.<span class="property">messageContent</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> digest = item.<span class="property">lastMessage</span>.<span class="property">messageContent</span>.<span class="title function_">digest</span>(item.<span class="property">lastMessage</span>)</span><br><span class="line">      digest = digest.<span class="title function_">replace</span>(<span class="regexp">/\n/g</span>, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">      item.<span class="property">ui</span>.<span class="property">lastMsgContent</span> = digest</span><br><span class="line">      item.<span class="property">ui</span>.<span class="property">time</span> = <span class="title function_">timeFormat</span>(item.<span class="property">lastMessage</span>.<span class="property">timestamp</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> item</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;cl&#x27;</span>, clUi)</span><br><span class="line">  conversations.<span class="property">value</span> = clUi</span><br><span class="line">  isLoading.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 页面跳转</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">chatTo</span> = (<span class="params">e: any</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> item = e.<span class="property">currentTarget</span>.<span class="property">dataset</span>.<span class="property">item</span></span><br><span class="line">  wfc.<span class="title function_">clearConversationUnreadStatus</span>(item.<span class="property">conversation</span>)</span><br><span class="line">  <span class="keyword">delete</span> item.<span class="property">unread</span></span><br><span class="line">  uni.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`/pagesChat/pages/ChatPage/index?conversation=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(item.conversation)&#125;</span>`</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onConversationLongTap</span> = (<span class="params">e: any</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> conversationInfo = e.<span class="property">currentTarget</span>.<span class="property">dataset</span>.<span class="property">item</span></span><br><span class="line">  <span class="keyword">const</span> menuItems = [<span class="string">&#x27;清空会话&#x27;</span>, <span class="string">&#x27;删除会话&#x27;</span>]</span><br><span class="line">  <span class="keyword">if</span> (conversationInfo.<span class="property">isTop</span>) &#123;</span><br><span class="line">    menuItems.<span class="title function_">push</span>(<span class="string">&#x27;取消置顶&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    menuItems.<span class="title function_">push</span>(<span class="string">&#x27;会话置顶&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  uni.<span class="title function_">showActionSheet</span>(&#123;</span><br><span class="line">    <span class="attr">itemList</span>: menuItems,</span><br><span class="line">    <span class="title function_">success</span>(<span class="params">res</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> item = menuItems[res.<span class="property">tapIndex</span>]</span><br><span class="line">      <span class="keyword">switch</span> (item) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;清空会话&#x27;</span>:</span><br><span class="line">          wfc.<span class="title function_">clearMessages</span>(conversationInfo.<span class="property">conversation</span>)</span><br><span class="line">          <span class="title function_">showConversationList</span>()</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;删除会话&#x27;</span>:</span><br><span class="line">          wfc.<span class="title function_">removeConversation</span>(conversationInfo.<span class="property">conversation</span>, <span class="literal">true</span>)</span><br><span class="line">          <span class="title function_">showConversationList</span>()</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;会话置顶&#x27;</span>:</span><br><span class="line">          wfc.<span class="title function_">setConversationTop</span>(conversationInfo.<span class="property">conversation</span>, <span class="literal">true</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;取消置顶&#x27;</span>:</span><br><span class="line">          wfc.<span class="title function_">setConversationTop</span>(conversationInfo.<span class="property">conversation</span>, <span class="literal">false</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">fail</span>(<span class="params">res</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">errMsg</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生命周期</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">ConnectionStatusChanged</span>, onConnnectionStatusChange)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">UserInfosUpdate</span>, onUserInfosUpdate)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">GroupInfosUpdate</span>, onGroupInfosUpdate)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">ReceiveMessage</span>, onReceiveMessage)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">SettingUpdate</span>, onSettingUpdate)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">ConversationInfoUpdate</span>, onConversationInfoUpdate)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">removeListener</span>(<span class="title class_">EventType</span>.<span class="property">ConnectionStatusChanged</span>, onConnnectionStatusChange)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">removeListener</span>(<span class="title class_">EventType</span>.<span class="property">UserInfosUpdate</span>, onUserInfosUpdate)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">removeListener</span>(<span class="title class_">EventType</span>.<span class="property">GroupInfosUpdate</span>, onGroupInfosUpdate)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">removeListener</span>(<span class="title class_">EventType</span>.<span class="property">ReceiveMessage</span>, onReceiveMessage)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">removeListener</span>(<span class="title class_">EventType</span>.<span class="property">SettingUpdate</span>, onSettingUpdate)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">onShow</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> userId = wx.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;userId&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> token = wx.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (userId &amp;&amp; token) &#123;</span><br><span class="line">    wfc.<span class="title function_">connect</span>(userId, token)</span><br><span class="line">    wfc.<span class="title function_">onForeground</span>()</span><br><span class="line">    <span class="keyword">if</span> (wfc.<span class="title function_">getConnectionStatus</span>() === <span class="title class_">ConnectionStatus</span>.<span class="property">ConnectionStatusConnected</span>) &#123;</span><br><span class="line">      <span class="title function_">showConversationList</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载头像错误处理</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadPortraitError</span> = (<span class="params">e: Event</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;load conversation target portrait error&#x27;</span>, e)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="对话详情"><a href="#对话详情" class="headerlink" title="对话详情"></a>对话详情</h2><p>对话详情会比对话页面复杂些，因为有各种消息类型需要处理，而且在例子中涉及文件较多，但都可以用 ai 处理转为 uniapp 语法</p>
<p>需要把<code>pages/chat</code>下的<code>ui.js</code>和<code>msg-type</code>目录拷贝到对应的页面下，当然，也可以放到其他文件，只需要改一下引入即可</p>
<p>示例项目中，会涉及到 chatinput、chatitem、chatword、chatloading、、chattime 等多个文件，需要将对应的文件一个一个转为符合自己需求的文件即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, onMounted, onUnmounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="variable constant_">UI</span> <span class="keyword">from</span> <span class="string">&#x27;./ui&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; onLoad, onShow &#125; <span class="keyword">from</span> <span class="string">&#x27;@dcloudio/uni-app&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VoiceManager</span> <span class="keyword">from</span> <span class="string">&#x27;./msg-type/voice-manager&#x27;</span></span><br><span class="line"><span class="keyword">import</span> wfc <span class="keyword">from</span> <span class="string">&#x27;@/wfc/client/wfc&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ConversationInfo</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/model/conversationInfo&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TextMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/textMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">WelcomeMgsMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/welcomeMgsMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CopyTextMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/copyTextMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">EventType</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/client/wfcEvent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Conversation</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/model/conversation&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ImageMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/imageMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">SoundMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/soundMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MessageStatus</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/messageStatus&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NotificationMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/notification/notificationMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; eq, gt, numberValue &#125; <span class="keyword">from</span> <span class="string">&#x27;@/wfc/util/longUtil&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; timeFormat &#125; <span class="keyword">from</span> <span class="string">&#x27;@/wfc/util/time&#x27;</span></span><br><span class="line"><span class="keyword">import</span> avenginekitproxy <span class="keyword">from</span> <span class="string">&#x27;@/wfc/av/engine/avenginekitproxy&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ConversationType</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/model/conversationType&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CallStartMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/av/messages/callStartMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ConferenceInviteMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/av/messages/conferenceInviteMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">StreamingTextGeneratingMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/streamingTextGeneratingMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">StreamingTextGeneratedMessageContent</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/streamingTextGeneratedMessageContent&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MessageContentType</span> <span class="keyword">from</span> <span class="string">&#x27;@/wfc/messages/messageContentType&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ChatInput</span> <span class="keyword">from</span> <span class="string">&#x27;./components/ChatInput.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ChatItem</span> <span class="keyword">from</span> <span class="string">&#x27;./components/ChatItem.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义响应式数据</span></span><br><span class="line"><span class="keyword">const</span> conversation = ref&lt;<span class="title class_">Conversation</span>&gt;(<span class="keyword">new</span> <span class="title class_">Conversation</span>())</span><br><span class="line"><span class="keyword">const</span> lastTimestamp = ref&lt;number&gt;(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> textMessage = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> chatItems = ref&lt;any[]&gt;([])</span><br><span class="line"><span class="keyword">const</span> latestPlayVoicePath = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> chatStatue = <span class="title function_">ref</span>(<span class="string">&#x27;open&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> isLoadAll = <span class="title function_">ref</span>(<span class="literal">false</span>)</span><br><span class="line"><span class="keyword">const</span> extraArr = <span class="title function_">ref</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">picName</span>: <span class="string">&#x27;choose_picture&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;照片&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">picName</span>: <span class="string">&#x27;take_photos&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;拍摄&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">picName</span>: <span class="string">&#x27;take_photos&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;音频通话&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">picName</span>: <span class="string">&#x27;take_photos&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;视频通话&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">])</span><br><span class="line"><span class="keyword">const</span> scrollTopVal = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> pageHeight = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="title class_">UIInstance</span>: <span class="variable constant_">UI</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">voiceManager</span>: <span class="title class_">VoiceManager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_isDisplayMessage</span>(<span class="params">message</span>) &#123;</span><br><span class="line">  <span class="comment">// return [PersistFlag.Persist, PersistFlag.Persist_And_Count].indexOf(MessageConfig.getMessageContentPersitFlag(message.messageContent.type)) &gt; -1;</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    message.<span class="property">messageId</span> !== <span class="number">0</span> ||</span><br><span class="line">    message.<span class="property">messageContent</span>.<span class="property">type</span> === <span class="title class_">MessageContentType</span>.<span class="property">Streaming_Text_Generating</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onReceiveMessage</span>(<span class="params">msg: any</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!msg.<span class="property">conversation</span>.<span class="title function_">equal</span>(conversation.<span class="property">value</span>) || !<span class="title function_">_isDisplayMessage</span>(msg)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  wfc.<span class="title function_">clearConversationUnreadStatus</span>(conversation.<span class="property">value</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> msgIndex = chatItems.<span class="property">value</span>.<span class="title function_">findIndex</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      m.<span class="property">messageId</span> === msg.<span class="property">messageId</span> ||</span><br><span class="line">      (<span class="title function_">gt</span>(m.<span class="property">messageUid</span>, <span class="number">0</span>) &amp;&amp; <span class="title function_">eq</span>(m.<span class="property">messageUid</span>, msg.<span class="property">messageUid</span>)) ||</span><br><span class="line">      (m.<span class="property">messageContent</span>.<span class="property">type</span> === <span class="title class_">MessageContentType</span>.<span class="property">Streaming_Text_Generating</span> &amp;&amp;</span><br><span class="line">        (msg.<span class="property">messageContent</span>.<span class="property">type</span> === <span class="title class_">MessageContentType</span>.<span class="property">Streaming_Text_Generating</span> ||</span><br><span class="line">          msg.<span class="property">messageContent</span>.<span class="property">type</span> === <span class="title class_">MessageContentType</span>.<span class="property">Streaming_Text_Generated</span>) &amp;&amp;</span><br><span class="line">        m.<span class="property">messageContent</span>.<span class="property">streamId</span> === msg.<span class="property">messageContent</span>.<span class="property">streamId</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newUIMsg = <span class="title function_">messagesToUiMessages</span>([msg])[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">if</span> (msgIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    chatItems.<span class="property">value</span>[msgIndex] = newUIMsg</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    chatItems.<span class="property">value</span>.<span class="title function_">push</span>(newUIMsg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scrollTopVal.<span class="property">value</span> = chatItems.<span class="property">value</span>.<span class="property">length</span> * <span class="number">999</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onSendMessage</span>(<span class="params">msg: any</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!msg.<span class="property">conversation</span>.<span class="title function_">equal</span>(conversation.<span class="property">value</span>)) <span class="keyword">return</span></span><br><span class="line">  <span class="title function_">showMessageList</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onMessageStatusUpdate</span>(<span class="params">msg: any</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!msg.<span class="property">conversation</span>.<span class="title function_">equal</span>(conversation.<span class="property">value</span>)) <span class="keyword">return</span></span><br><span class="line">  <span class="title function_">showMessageList</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onRecallMessage</span>(<span class="params">operator: string, messageUid: number</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> msg = wfc.<span class="title function_">getMessageByUid</span>(messageUid)</span><br><span class="line">  <span class="keyword">if</span> (!msg.<span class="property">conversation</span>.<span class="title function_">equal</span>(conversation.<span class="property">value</span>)) <span class="keyword">return</span></span><br><span class="line">  <span class="title function_">showMessageList</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">onShow</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  wfc.<span class="title function_">onForeground</span>()</span><br><span class="line">  <span class="title function_">showMessageList</span>()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">onLoad</span>(<span class="function">(<span class="params">options</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;------------chat onLoad----------&#x27;</span>, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> conversationJson = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(options.<span class="property">conversation</span>)</span><br><span class="line">  pageHeight.<span class="property">value</span> = uni.<span class="title function_">getSystemInfoSync</span>().<span class="property">windowHeight</span></span><br><span class="line">  conversation.<span class="property">value</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="keyword">new</span> <span class="title class_">Conversation</span>(), conversationJson)</span><br><span class="line">  <span class="keyword">const</span> conversationInfo = <span class="keyword">new</span> <span class="title class_">ConversationInfo</span>()</span><br><span class="line">  conversationInfo.<span class="property">conversation</span> = conversation.<span class="property">value</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    <span class="string">&#x27;------------chat onLoad----------&#x27;</span>,</span><br><span class="line">    options,</span><br><span class="line">    conversation.<span class="property">value</span>,</span><br><span class="line">    conversationInfo.<span class="property">conversation</span>,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  uni.<span class="title function_">setNavigationBarTitle</span>(&#123;</span><br><span class="line">    <span class="attr">title</span>: conversationInfo.<span class="title function_">title</span>() || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title class_">UIInstance</span> = <span class="keyword">new</span> <span class="title function_">UI</span>(<span class="title function_">getCurrentInstance</span>())</span><br><span class="line">  voiceManager = <span class="keyword">new</span> <span class="title class_">VoiceManager</span>(<span class="title function_">getCurrentInstance</span>())</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册事件监听</span></span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">ReceiveMessage</span>, onReceiveMessage)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">SendMessage</span>, onSendMessage)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">MessageStatusUpdate</span>, onMessageStatusUpdate)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">on</span>(<span class="title class_">EventType</span>.<span class="property">RecallMessage</span>, onRecallMessage)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  voiceManager.<span class="title function_">stopAllVoicePlay</span>(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">off</span>(<span class="title class_">EventType</span>.<span class="property">ReceiveMessage</span>, onReceiveMessage)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">off</span>(<span class="title class_">EventType</span>.<span class="property">SendMessage</span>, onSendMessage)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">off</span>(<span class="title class_">EventType</span>.<span class="property">MessageStatusUpdate</span>, onMessageStatusUpdate)</span><br><span class="line">  wfc.<span class="property">eventEmitter</span>.<span class="title function_">off</span>(<span class="title class_">EventType</span>.<span class="property">RecallMessage</span>, onRecallMessage)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onSendMessageEvent</span>(<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> content = e.<span class="property">detail</span>.<span class="property">value</span></span><br><span class="line">  <span class="keyword">const</span> textMsgContent = <span class="keyword">new</span> <span class="title class_">TextMessageContent</span>(content)</span><br><span class="line">  <span class="title function_">sendMessage</span>(textMsgContent)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onSendCopyMessageEvent</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> textMsgContent = <span class="keyword">new</span> <span class="title class_">CopyTextMessageContent</span>(msg)</span><br><span class="line">  <span class="title function_">sendMessage</span>(textMsgContent)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendMessage</span>(<span class="params">messageContent: any</span>) &#123;</span><br><span class="line">  wfc.<span class="title function_">sendConversationMessage</span>(</span><br><span class="line">    conversation.<span class="property">value</span>,</span><br><span class="line">    messageContent,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">showMessageList</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">(<span class="params">progress, total</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;upload progress&#x27;</span>, progress, total)</span><br><span class="line">      <span class="title function_">showMessageList</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">showMessageList</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">showMessageList</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadOldMessages</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;loadOldMessages&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> messages = chatItems.<span class="property">value</span></span><br><span class="line">  <span class="keyword">const</span> beforeUid = messages.<span class="property">length</span> &gt; <span class="number">0</span> ? messages[<span class="number">0</span>].<span class="property">messageUid</span> : <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> beforeId = messages.<span class="property">length</span> &gt; <span class="number">0</span> ? messages[<span class="number">0</span>].<span class="property">messageId</span> : <span class="number">0</span></span><br><span class="line">  wfc.<span class="title function_">getMessagesV2</span>(</span><br><span class="line">    conversation.<span class="property">value</span>,</span><br><span class="line">    beforeId,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    <span class="number">20</span>,</span><br><span class="line">    <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="function">(<span class="params">msgs</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (msgs.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> uiMsgs = <span class="title function_">messagesToUiMessages</span>(msgs)</span><br><span class="line">        uiMsgs = uiMsgs.<span class="title function_">concat</span>(messages)</span><br><span class="line">        chatItems.<span class="property">value</span> = uiMsgs</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;chatItems.value&#x27;</span>, uiMsgs)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        wfc.<span class="title function_">loadRemoteConversationMessages</span>(</span><br><span class="line">          conversation.<span class="property">value</span>,</span><br><span class="line">          [],</span><br><span class="line">          beforeUid,</span><br><span class="line">          <span class="number">50</span>,</span><br><span class="line">          <span class="function">(<span class="params">msgs</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (msgs.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">let</span> uiMsgs = <span class="title function_">messagesToUiMessages</span>(msgs)</span><br><span class="line">              <span class="keyword">if</span> (uiMsgs.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                isLoadAll.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">              uiMsgs = uiMsgs.<span class="title function_">concat</span>(messages)</span><br><span class="line">              chatItems.<span class="property">value</span> = uiMsgs</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;chatItems.value&#x27;</span>, uiMsgs)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              isLoadAll.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="function">(<span class="params">errorCode</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;load remote message error&#x27;</span>, errorCode)</span><br><span class="line">          &#125;,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;load remote message error&#x27;</span>, err)</span><br><span class="line">    &#125;,</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showMessageList</span>(<span class="params"></span>) &#123;</span><br><span class="line">  wfc.<span class="title function_">getMessagesV2</span>(</span><br><span class="line">    conversation.<span class="property">value</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    <span class="number">20</span>,</span><br><span class="line">    <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="function">(<span class="params">messages</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;getMessagesV2&#x27;</span>, messages)</span><br><span class="line">      <span class="keyword">if</span> (messages.<span class="property">length</span> &lt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="title function_">loadOldMessages</span>()</span><br><span class="line">        <span class="keyword">if</span> (messages.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> uiMsgs = <span class="title function_">messagesToUiMessages</span>(messages)</span><br><span class="line">      chatItems.<span class="property">value</span> = uiMsgs</span><br><span class="line">      scrollTopVal.<span class="property">value</span> = uiMsgs.<span class="property">length</span> * <span class="number">999</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;getMessagesV2 error&#x27;</span>, conversation.<span class="property">value</span>, err)</span><br><span class="line">    &#125;,</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">messagesToUiMessages</span>(<span class="params">messages: any[]</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> messages.<span class="title function_">map</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> item = &#123;</span><br><span class="line">      <span class="attr">showTime</span>: <span class="title function_">numberValue</span>(m.<span class="property">timestamp</span>) - lastTimestamp.<span class="property">value</span> &gt; <span class="number">2</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">time</span>: <span class="title function_">timeFormat</span>(m.<span class="property">timestamp</span>),</span><br><span class="line">      <span class="attr">headUrl</span>: wfc.<span class="title function_">getUserInfo</span>(m.<span class="property">from</span>).<span class="property">portrait</span>,</span><br><span class="line">      <span class="attr">isMy</span>: m.<span class="property">direction</span> === <span class="number">0</span>,</span><br><span class="line">      <span class="attr">isPlaying</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">sendStatus</span>: <span class="string">&#x27;sending&#x27;</span> | <span class="string">&#x27;success&#x27;</span> | <span class="string">&#x27;failed&#x27;</span>,</span><br><span class="line">      <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (m.<span class="property">status</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">MessageStatus</span>.<span class="property">Sending</span>:</span><br><span class="line">        item.<span class="property">sendStatus</span> = <span class="string">&#x27;sending&#x27;</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">MessageStatus</span>.<span class="property">Sent</span>:</span><br><span class="line">        item.<span class="property">sendStatus</span> = <span class="string">&#x27;success&#x27;</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">MessageStatus</span>.<span class="property">SendFailure</span>:</span><br><span class="line">        item.<span class="property">sendStatus</span> = <span class="string">&#x27;failed&#x27;</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m.<span class="property">messageContent</span> <span class="keyword">instanceof</span> <span class="title class_">TextMessageContent</span>) &#123;</span><br><span class="line">      item.<span class="property">content</span> = m.<span class="property">messageContent</span>.<span class="property">content</span></span><br><span class="line">      item.<span class="property">type</span> = <span class="string">&#x27;text&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (m.<span class="property">messageContent</span> <span class="keyword">instanceof</span> <span class="title class_">WelcomeMgsMessageContent</span>) &#123;</span><br><span class="line">      item.<span class="property">content</span> = m.<span class="property">messageContent</span>.<span class="property">content</span></span><br><span class="line">      item.<span class="property">type</span> = <span class="string">&#x27;welcome-msg&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (m.<span class="property">messageContent</span> <span class="keyword">instanceof</span> <span class="title class_">CopyTextMessageContent</span>) &#123;</span><br><span class="line">      item.<span class="property">content</span> = m.<span class="property">messageContent</span>.<span class="property">content</span></span><br><span class="line">      item.<span class="property">type</span> = <span class="string">&#x27;copy-text&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (m.<span class="property">messageContent</span> <span class="keyword">instanceof</span> <span class="title class_">ImageMessageContent</span>) &#123;</span><br><span class="line">      item.<span class="property">content</span> = m.<span class="property">messageContent</span>.<span class="property">localPath</span> || m.<span class="property">messageContent</span>.<span class="property">remotePath</span></span><br><span class="line">      item.<span class="property">type</span> = <span class="string">&#x27;image&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (m.<span class="property">messageContent</span> <span class="keyword">instanceof</span> <span class="title class_">SoundMessageContent</span>) &#123;</span><br><span class="line">      item.<span class="property">content</span> = m.<span class="property">messageContent</span>.<span class="property">localPath</span> || m.<span class="property">messageContent</span>.<span class="property">remotePath</span></span><br><span class="line">      item.<span class="property">type</span> = <span class="string">&#x27;voice&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastTimestamp.<span class="property">value</span> = <span class="title function_">numberValue</span>(m.<span class="property">timestamp</span>)</span><br><span class="line">    m.<span class="property">ui</span> = item</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义消息类型"><a href="#自定义消息类型" class="headerlink" title="自定义消息类型"></a>自定义消息类型</h2><p><a target="_blank" rel="noopener" href="https://docs.wildfirechat.cn/base_knowledge/custom_message_content.html?h=%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B">自定义消息类型</a>，官方文档里面写了对应的文档</p>
<p>这里给出一个基于 text 消息类型衍生的增加复制按钮的消息类型 CopyTextMessage</p>
<p>因为这个消息类型下，只需要增加一个复制按钮即可，其他的和 text 消息类型一样，所以这个例子很简单</p>
<h3 id="消息类型定义"><a href="#消息类型定义" class="headerlink" title="消息类型定义"></a>消息类型定义</h3><p>在<code>wfc/message</code>目录下，新建一个文件<code>CopyTextMessageContent.ts</code>作为消息类型定义的文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2020 WildFireChat. All rights reserved.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MessageContent</span> <span class="keyword">from</span> <span class="string">&quot;./messageContent&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MessageContentType</span> <span class="keyword">from</span> <span class="string">&quot;./messageContentType&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> wfc <span class="keyword">from</span> <span class="string">&quot;../client/wfc&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">QuoteInfo</span> <span class="keyword">from</span> <span class="string">&quot;../model/quoteInfo&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">copyTextMessageContent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">MessageContent</span> &#123;</span><br><span class="line">  content;</span><br><span class="line">  quoteInfo;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">content, mentionedType = <span class="number">0</span>, mentionedTargets = []</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(<span class="title class_">MessageContentType</span>.<span class="property">Copy_Text</span>, mentionedType, mentionedTargets);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">content</span> = content;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">digest</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">content</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">encode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> payload = <span class="variable language_">super</span>.<span class="title function_">encode</span>();</span><br><span class="line">    payload.<span class="property">searchableContent</span> = <span class="variable language_">this</span>.<span class="property">content</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">quoteInfo</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> obj = &#123;</span><br><span class="line">        <span class="attr">quote</span>: <span class="variable language_">this</span>.<span class="property">quoteInfo</span>.<span class="title function_">encode</span>(),</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">// JSON.parse 和 JSON.stringify 不能处理java long</span></span><br><span class="line">      <span class="keyword">const</span> orgStr = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj);</span><br><span class="line">      <span class="keyword">const</span> str = orgStr.<span class="title function_">replace</span>(<span class="regexp">/&quot;u&quot;:&quot;([0-9]+)&quot;/</span>, <span class="string">&#x27;&quot;u&quot;:$1&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      payload.<span class="property">binaryContent</span> = wfc.<span class="title function_">utf8_to_b64</span>(str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> payload;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">decode</span>(<span class="params">payload</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">decode</span>(payload);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">content</span> = payload.<span class="property">searchableContent</span>;</span><br><span class="line">    <span class="keyword">if</span> (payload.<span class="property">binaryContent</span> &amp;&amp; payload.<span class="property">binaryContent</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// JSON.parse 和 JSON.stringify 不能处理java long</span></span><br><span class="line">      <span class="keyword">let</span> quoteInfoStr = wfc.<span class="title function_">b64_to_utf8</span>(payload.<span class="property">binaryContent</span>);</span><br><span class="line">      <span class="comment">// FIXME node 环境，decodeURIComponent 方法，有时候会在最后添加上@字符，目前尚未找到原因，先规避</span></span><br><span class="line">      quoteInfoStr = quoteInfoStr.<span class="title function_">substring</span>(</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        quoteInfoStr.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;&#125;&quot;</span>) + <span class="number">1</span></span><br><span class="line">      );</span><br><span class="line">      quoteInfoStr = quoteInfoStr.<span class="title function_">replace</span>(<span class="regexp">/&quot;u&quot;:([0-9]+),/</span>, <span class="string">&#x27;&quot;u&quot;:&quot;$1&quot;,&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> obj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(quoteInfoStr).<span class="property">quote</span>;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">quoteInfo</span> = <span class="keyword">new</span> <span class="title class_">QuoteInfo</span>();</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">quoteInfo</span>.<span class="title function_">decode</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">setQuoteInfo</span>(<span class="params">quoteInfo</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">quoteInfo</span> = quoteInfo;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="声明消息类型"><a href="#声明消息类型" class="headerlink" title="声明消息类型"></a>声明消息类型</h3><ul>
<li><p><code>wfc/message/messageContentType</code></p>
<p>增加消息类型对应的枚举</p>
<p><code>static Copy_Text = 17</code></p>
</li>
<li><p><code>wfc/client/messageConfig</code></p>
<p>增加消息类型列表，在<code>MessageContents</code>变量中添加</p>
</li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ import CopyTextMessageContent from &#x27;../messages/copyTextMessageContent&#x27;</span></span><br><span class="line">static MessageContents = [</span><br><span class="line">...</span><br><span class="line"><span class="addition">+ &#123;</span></span><br><span class="line"><span class="addition">+ name: &#x27;copy-text&#x27;,</span></span><br><span class="line"><span class="addition">+ flag: PersistFlag.Persist_And_Count,</span></span><br><span class="line"><span class="addition">+ type: MessageContentType.CopyTextMessageContent,</span></span><br><span class="line"><span class="addition">+ contentClazz: WelcomeMgsMessageContent,</span></span><br><span class="line"><span class="addition">+ &#125;,</span></span><br><span class="line">...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>wfc/model/favItem</code></p>
<p><code>fromMessage</code>修改内容返回，这里主要用于消息列表的最新消息显示</p>
</li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ import CopyTextMessageContent from &#x27;../messages/copyTextMessageContent&#x27;</span></span><br><span class="line">switch (message.messageContent.type) &#123;</span><br><span class="line">case MessageContentType.Text:</span><br><span class="line">    const textMessageContent = message.messageContent</span><br><span class="line">    favItem.title = textMessageContent.content</span><br><span class="line">    break</span><br><span class="line"><span class="addition">+ case MessageContentType.Copy_Text:</span></span><br><span class="line"><span class="addition">+    const CopyTextMessageContent = message.messageContent</span></span><br><span class="line">    favItem.title = CopyTextMessageContent.content</span><br><span class="line">    break</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul>
<li><p>格式化消息列表</p>
<p>在聊天内容列表，增加对自定义消息类型的处理</p>
</li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function messagesToUiMessages(messages: any[]) &#123;</span><br><span class="line">    ...</span><br><span class="line">    if (m.messageContent instanceof TextMessageContent) &#123;</span><br><span class="line">    item.content = m.messageContent.content;</span><br><span class="line">    item.type = &quot;text&quot;;</span><br><span class="line"><span class="addition">+         &#125; else if (m.messageContent instanceof CopyTextMessageContent) &#123;</span></span><br><span class="line"><span class="addition">+          item.content = m.messageContent.content;</span></span><br><span class="line"><span class="addition">+          item.type = &quot;copy-text&quot;;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>发送自定义消息类型</li>
</ul>
<p>当需要发送对应类型的消息文本时，需要引入对应的消息类型 class 声明，并创建一个实例传给 sendMessage</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">CopyTextMessageContent</span> <span class="keyword">from</span> <span class="string">&quot;@/wfc/messages/copyTextMessageContent&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onSendCopyMessageEvent</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> textMsgContent = <span class="keyword">new</span> <span class="title class_">CopyTextMessageContent</span>(msg);</span><br><span class="line">  <span class="title function_">sendMessage</span>(textMsgContent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义消息类型显示</li>
</ul>
<p>野火通过type来区分不同的消息类型，因此在<code>chatWord</code>文件中，需要加上自定义消息类型的ui代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 复制文本消息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">v-if</span>=<span class="string">&quot;type === &#x27;copy-text&#x27;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;message-content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:class</span>=<span class="string">&quot;&#123; isMyWordStyle: isMy, isOtherWordStyle: !isMy &#125;&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:style</span>=<span class="string">&quot;&#123;</span></span></span><br><span class="line"><span class="string"><span class="tag">          wordWrap: &#x27;break-word&#x27;,</span></span></span><br><span class="line"><span class="string"><span class="tag">          borderRadius: isMy ? &#x27;16rpx 0px 16rpx 16rpx&#x27; : &#x27;0px 16rpx 16rpx 16rpx&#x27;,</span></span></span><br><span class="line"><span class="string"><span class="tag">        &#125;&quot;</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">click</span>=<span class="string">&quot;handleTextClick&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:data-index</span>=<span class="string">&quot;index&quot;</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;inline&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;text in content&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;text&quot;</span>&gt;</span> &#123;&#123; text &#125;&#125; <span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span></span></span><br><span class="line"><span class="tag">      <span class="attr">:src</span>=<span class="string">&quot;copyIcon&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;inline-block ml-16rpx w-40rpx h-40rpx align-top&quot;</span></span></span><br><span class="line"><span class="tag">      @<span class="attr">click</span>=<span class="string">&quot;onCopy&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/08/14/%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E3%80%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E3%80%91uniapp%E5%BC%95%E5%85%A5%E9%87%8E%E7%81%AB%E5%AF%B9%E8%AF%9D/" data-id="cmf67fxdx004jbcfm2vjp4xr8" data-title="【小程序】uniapp引入野火对话" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/">JS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWA/">PWA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/React-Native/">React Native</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Typescript/">Typescript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/VueTest/">VueTest</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web3/">Web3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/axios-%E6%BA%90%E7%A0%81/">axios 源码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/react/">react</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuex-%E6%BA%90%E7%A0%81/">vuex 源码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web3/">web3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/webAssembly/">webAssembly</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/webpack/">webpack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/webwork/">webwork</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/">业务场景</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB/">扩展阅读</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/">浏览器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A2%9D%E5%A4%96%E5%86%85%E5%AE%B9/">额外内容</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Typescript/" rel="tag">Typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VueTest/" rel="tag">VueTest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web3/" rel="tag">Web3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/axios-%E6%BA%90%E7%A0%81/" rel="tag">axios 源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chrome/" rel="tag">chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/console/" rel="tag">console</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/" rel="tag">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vuex-%E6%BA%90%E7%A0%81/" rel="tag">vuex 源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web3/" rel="tag">web3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webAssembly/" rel="tag">webAssembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webRTC/" rel="tag">webRTC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webwork/" rel="tag">webwork</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/" rel="tag">业务场景</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB/" rel="tag">扩展阅读</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" rel="tag">浏览器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8-Performance-Chrome/" rel="tag">浏览器 Performance Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A2%9D%E5%A4%96%E5%86%85%E5%AE%B9/" rel="tag">额外内容</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/Typescript/" style="font-size: 12px;">Typescript</a> <a href="/tags/VueTest/" style="font-size: 10px;">VueTest</a> <a href="/tags/Web3/" style="font-size: 20px;">Web3</a> <a href="/tags/axios-%E6%BA%90%E7%A0%81/" style="font-size: 14px;">axios 源码</a> <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/console/" style="font-size: 10px;">console</a> <a href="/tags/css/" style="font-size: 18px;">css</a> <a href="/tags/http/" style="font-size: 12px;">http</a> <a href="/tags/js/" style="font-size: 20px;">js</a> <a href="/tags/react/" style="font-size: 12px;">react</a> <a href="/tags/vue/" style="font-size: 14px;">vue</a> <a href="/tags/vuex-%E6%BA%90%E7%A0%81/" style="font-size: 12px;">vuex 源码</a> <a href="/tags/web3/" style="font-size: 12px;">web3</a> <a href="/tags/webAssembly/" style="font-size: 10px;">webAssembly</a> <a href="/tags/webRTC/" style="font-size: 12px;">webRTC</a> <a href="/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/tags/webwork/" style="font-size: 10px;">webwork</a> <a href="/tags/%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF/" style="font-size: 10px;">业务场景</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 20px;">前端</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 12px;">小程序</a> <a href="/tags/%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB/" style="font-size: 12px;">扩展阅读</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 16px;">浏览器</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8-Performance-Chrome/" style="font-size: 10px;">浏览器 Performance Chrome</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 14px;">面试</a> <a href="/tags/%E9%A2%9D%E5%A4%96%E5%86%85%E5%AE%B9/" style="font-size: 10px;">额外内容</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">September 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">August 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/09/05/Vue/%E3%80%90vue%E3%80%91%E8%AF%A6%E8%A7%A3computed/">详解computed</a>
          </li>
        
          <li>
            <a href="/2025/08/25/%E9%9D%A2%E8%AF%95/%E3%80%90%E9%9D%A2%E8%AF%95%E3%80%91%E6%B1%87%E6%80%BB2/">记录3</a>
          </li>
        
          <li>
            <a href="/2025/08/22/%E9%9D%A2%E8%AF%95/%E3%80%90%E9%9D%A2%E8%AF%95%E3%80%91%E6%B1%87%E6%80%BB1/">记录2</a>
          </li>
        
          <li>
            <a href="/2025/08/20/%E9%9D%A2%E8%AF%95/%E3%80%90%E9%9D%A2%E8%AF%95%E3%80%91%E5%A4%96%E5%8C%85/">记录1</a>
          </li>
        
          <li>
            <a href="/2025/08/14/%E6%89%8B%E5%86%99%E9%A2%98/">手写题</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 yangxin<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>