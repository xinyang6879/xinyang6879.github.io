---
title: webRTC介绍
categories: 扩展阅读
tags:
  - 扩展阅读
  - webRTC
---

## webRTC 介绍

webrtc，Web Real-time Communication，web 实时通信技术，其开创性的使浏览器能直接与其他浏览器进行交互，从而形成包括三角模式和梯形模式在内的多种体系结构

实时通信技术通过标准 api 和 web 应用程序交互，并使用浏览器与操作系统通信。

webrtc 增加新的特点 - 浏览器和浏览器之间的交互（对等连接）。在此类交互上，一个浏览器中的实时通信功能使用线上标准协议（非 http），与另一个浏览器或网络电话或视频应用程序之中的实时通信功能进行通信。虽然使用 tcp 传输 web 流量，但浏览器之间的线上可使用其他传输协议，例如 udp。

    - 提供信令服务，该服务器在浏览器和对等连接另一端提供信令通道

### webrtc 所包含的元素

- web 服务器
- 运行于各种设备和操作系统之上的浏览器，包括台式机、pad、手机和其他服务器
- 其他：共用交换电话网（PSTN）门户、其他互联网通信终端（会话发起协议电话、客户端，或者 Jingle 客户端

webrtc 支持以上所有设备的通信

### 三角模式和梯形模式

- 三角模式

  最常见的情况可能是两个浏览器都运行从同一个 web 服务器下载的同一个 webrtc web 应用程序，因为这三个元素之间的信令路线和媒体或数据流动路线所构成的形状恰好是一个三角形，因此成为 webrtc 三角形。两个浏览器之间直接通过建立对等连接来传输语音、视频媒体，以及附加数据

  信令在 webrtc 中并未标准化，其只被视作未应用程序的一部分。信令可以通过 http 或 websocket 传送到向浏览器提供 html 页面的同一 web 服务器，也可传送到只负责处理信令的一个完全不同的 web 服务器

- 梯形模式

  其包含两台 web 服务器和两个浏览器，web 服务器之间采用标准的信令协议。例如 SIP 或 Jingle，也可以使用专有的信令协议。客户端和三角模式一样，通过对等连接传输音视频

### webrtc 与协议

- SIP

  web 服务器有一个内置的 sip 信令网关，浏览器与 sip 客户端之间可以通过此网关来交换呼叫建立信息，直接在浏览器和 sip 客户端之间形成媒体流，因为对等连接与 sip 用户代理建立标准的实时传输协议 RTP 媒体会话

  web 服务器 <--- SIP ---> SIP 服务器 <--- SIP ---> SIP 客户端 <--- 对等连接（音视频） ---> 浏览器 <------> web 服务器

- Jingle

  web 服务器有一个内置的可扩展消息现场协议，该内置服务器通过另一个 xmpp 服务器与 jingle 客户端进行通信

  web 服务器 <--- Jingle ---> XMPP 服务器 <--- Jingle ---> Jingle 客户端 <--- 对等连接（音视频） ---> 浏览器 <------> web 服务器

- 公共交换电话网（PSTN）

  PSTN 网关是纯音频媒体流的终结点，负责 PSTN 电话呼叫与媒体相连。在 web 服务器与 PSTN 网关之间需要有某种形式的信令，可以是 SIP，也可以是主从控制协议。

  互联网通信服务可以为用户分配一个电话号码，用户可以使用 webrtc 访问此服务。这样拨叫该电话号码时浏览器会发出“响铃”声，应答呼叫时则会通过与 PSTN 呼叫方相连的互联网建立语音会话，其他服务可能包括能在 webrtc 应用程序中“拨打电话”，这种拨打会通过互联网与 PSTN 建立语音通道

  PSTN 网关 <------> 浏览器 <------> Web 服务器 <------> PSTN 网关 <------> 电话

### 媒体流

点对点 webrtc 会话中的多媒体流包括但不限于：麦克风音频流、应用程序共享视频流、前置摄像头视频流、后置摄像头视频流、网络摄像头视频流、立体声音频流

多方会话：

- 每个浏览器都与其他参与会话的浏览器建立一个对等连接
  优势：不需要媒体服务器基础架构、媒体延迟最低且质量高

  缺点：不适用于大型多方会议，每次新的浏览器加入都会导致其他浏览器带宽增加

- 通过一个集中式媒体服务器/混合器/选择器，每个浏览器与媒体服务器之间建立单个对等连接。每个浏览器向服务器发送媒体数据，由服务器混合后不经将其分发给其他浏览器。这样每次有新的浏览器加入后，其他浏览器不需要对这个新的浏览器建立连接
  优势：能扩展非常大的会话，同时可以最大幅度减少当有新参与者加入会话时每个浏览器所需的处理工作量

  缺点：只有一个浏览器或少量浏览器参与时，会降低效率

## 使用

### 建立 webRTC 会话

- 获取本地媒体
- 在浏览器和对等端（其他浏览器或终端）之间建立连接
- 将媒体和数据通道关联至该连接
- 交换会话描述

#### 获取本地媒体

有多种方式可以获取，webRTC 定义了一种常见方式：`getUserMedia`，此方法可以用于获取单个本地 MediaStream，在获取一个或多个媒体后，可以使用 MediaStream API 将它们组合到所需要的流中。为保护隐私，只有当浏览器获取用户许可后，才会批准 web 应用程序访问用户麦克风或摄像头的请求

#### 建立对等连接

`RTCPeerConnection`是 webrtc 核心，其可以在两个对等端之间建立连接。这不是通过服务器请求通信，而是直接在两个实体之间进行通信。就 webrtc 本身而言，对等连接就是两个或更多浏览器之间的本地媒体连接，这种模式很适用于多向通信

建立此连接需要一个新的`RTCPeerConnection`对象，其构造函数方法的唯一输入项是一个配置对象，该对象包括交互式连接建立技术（ICE）“打洞”通过各种网络地址切换（NAT）设备和防火墙所使用的信息

#### 交换媒体或数据

建立连接后，可将任意数量的本地媒体流关联到对等连接，以通过该连接发送至远端浏览器。同样也可以将任意数量的远端媒体流发送至对等连接的本地端，这样本地端就有了新的媒体流，而且可以像操作其他本地媒体流那样处理他们

每次更改媒体时，都需要在两个浏览器之间协商如何在连接通道中表示媒体。当从本地端或远程端发出添加或删除媒体的请求时，可请求浏览器生成相应的 RTCSessionDescription 对象（此容器存放会话描述，即有关如何建立媒体会话的信息），用于表示通过对等连接传输的所有媒体集合。利用 RTCPeerConnection，开发者可在会话描述被发送到远端前，根据需要查看或编辑会话描述。这样浏览器既可以处理编码器协商和编写会话描述协议 W（SDP），同时允许应用程序根据需要进行微调。

当两个浏览器交换完 RTCSessionDescription 对象后，即可建立媒体或数据会话。此时两个浏览器将开始打洞，打洞完毕后，即可协商密钥，以确保媒体会话的安全，最后可开始媒体或数据会话。交换对象后的所有活动通过浏览器执行 js 代码完成，应用程序的 js 代码还可以添加/删除 STUN 和 TURN 服务器

#### 关闭连接

在对等连接中，任一端浏览器都可以关闭连接，通过对 RTCPeerConnection 对象调用`close()`来指示连接已使用完毕，此操作会停止 ICE 处理和媒体流传输，同样，如果某一端的浏览器断开 Internet 连接或发送崩溃，媒体或数据通道中发送的持久连接请求将失效，另一端的浏览器将尝试重新开始打洞，并且在打洞失败后关闭会话。会话结束后，浏览器将删除会话授予的任何访问设备麦克风和摄像头的许可，因此在新的会话中，需要向用户请求新的许可

### 流程

提议/应答是一种媒体协商方式，为了确保双方在流媒体传输之前达成一致

    提议：一方向一方发送其支持并要设置的媒体类型和功能

    应答：另一方回应，提示在所提议的媒体类型和功能中，哪些是此会话支持并可以接受的

临时应答：对提议的应答，但是临时性或实验性，可能不是实际应答中提供的最终应答，最终应答将在后面的提议/应答交换中给出。临时应答可选，通常只在与某些模拟电话网络特征的 VoIP 系统或 PSTN 进行互操作时才会出现

当浏览器 A 与浏览器 B 的用户进行通信时，浏览器 A 的 js 将针对其需要的媒体提供基于约束的描述、请求媒体数据并获取用户许可。用户授予的许可必须绑定到网页所在的域，并且不能扩展到网页上的弹出窗口和其他框架。所需要的媒体会话信息由会话描述对象捕获。该对象是通过 web 服务器向浏览器 B 发送的提议。对于 A 如何将此提议发送到 B，webRTC 没有标准化方法，因此此过程可以通过多种方式完成，例如 xhr，收到会话描述对象提议后，B 将生成会话描述对象应答，并以相同的方式发送到 A，当交换完成后，开始打洞（和密钥协商），并最终交换媒体数据包

当关闭连接时，将导致对等连接关闭，对麦克风和摄像头的许可也全部失效

#### 建立 WebRTC 会话

    - 浏览器A从web服务器请求网页
    - 服务器想A提供带有WebRTC JS的网页
    - 浏览器B从web服务器请求网页
    - 服务器向B提供带有webRTC js的网页
    - A希望与B进行通信，并通过A的JS将A的会话描述对象（提议）发送到web服务器
    - 服务器将A的会话描述对象发送给B的JS
    - B的JS将B的会话描述对象（应答）发送到服务器
    - 服务器将B的会话描述对象发送到A
    - A和B开始打洞，以确认访问对方的最佳方式
    - 完成打洞后，A和B以安全的媒体通信协议密钥
    - AB开始交换语音、视频或数据

#### 三角模式建立会话

    - 浏览器A、B向web服务器请求数据
    - 服务器响应（h5、css、js
    - 服务器返回AB HTTPS（SDP对象B A）
    - AB连接成功后，ICE打洞
    - 密钥协商
    - 安全的媒体或数据会话

#### 梯形模式

    - 浏览器A向服务器1请求，B向服务器2请求
    - web服务器分别向浏览器响应
    - 浏览器A向服务器1发起https（SDP对象A）
    - 服务器1向服务器2发送jingle（`<jingle action='session-initiate'>`
    - 服务器2向B发送浏览器A的信息
    - 浏览器A向服务器2发送https SDP对象B
    - 服务器2向服务器1发送同意jingle(`<jingle action='session-accept'>`)
    - 服务器1向浏览器A发送B的信息
    - 浏览器AB开始ICE打洞、密钥协商、传输数据等
    - 浏览器A向服务器1发送关闭连接
    - 服务器1向服务器2发送jingle关闭（`<jingle action='session-terminate'>`）
    - 浏览器B关闭连接

#### SIP

    - 浏览器A向服务器发送请求，服务器返回响应
    - SIP用户代理向SIP服务器发送`REGISTER`，SIP服务器响应
    - 浏览器向服务器发送浏览器相关信息SDP A
    - 服务器向SIP服务器发送浏览器相关信息InVite SDP A
    - SIP服务器向SIP用户代理发送InVite SDP A
    - SIP用户代理响应接受，并将自己信息响应SDP S
    - SIP服务器接收到用户代理信息后，将其响应给web服务器
    - web服务器接收到后发送给浏览器
    - web服务器和sip服务器连接，sip服务器与sip用户代理连接（ACK）
    - 浏览器和sip用户代理开始ICE打洞、密钥协商、传输数据等
    - 浏览器A向web服务器发送关闭连接
    - web服务器向sip服务器发送关闭
    - SIP用户代理向SIP服务器发送CLOSE

#### Jingle

    - 浏览器A向服务器发送请求，服务器返回响应
    - 浏览器向服务器发送浏览器相关信息SDP A
    - 服务器向XMPP服务器发送jingle（`<jingle action='session-initiate'>`
    - XMPP服务器向Jingle客户端发送jingle（`<jingle action='session-initiate'>`
    - Jingle客户端发送同意jingle(`<jingle action='session-accept'>`)，XMPP服务器将其响应发送到web服务器
    - web服务器接收到后发送给浏览器，附带SDP对象J
    - 浏览器和Jingle客户端开始ICE打洞、密钥协商、传输数据等
    - Jingle客户端向XMPP服务器发送关闭（`<jingle action='session-terminate'>`）
    - XMPP服务器向web服务器发送关闭（`<jingle action='session-terminate'>`）
    - 服务器和浏览器关闭

#### PSTN

web服务器和pstn网关之间的信令可利用任意数量的信令和控制协议，甚至sip中继。pstn网关终止webRTC媒体会话并将音频连接到pstn中继或线路。应在浏览器和pstn网关之间协商G.711（PCM）编码格式，否则将需要对音频信号进行转码

    - 浏览器A向服务器请求
    - web服务器分别向浏览器响应
    - 浏览器A向服务器发起https（SDP对象A）
    - web服务器与PSIN网连建立连接，PSIN网联呼叫电话
    - 电话挂机PSIN网联，PSIN应答web服务器
    - 服务器与浏览器发送https，传输SDP对象网关
    - 浏览器与PSIN网联ICE打洞、密钥协商
    - 浏览器与PSIN传输媒体音频，语音会话时，还需要通过PSIN网联和电话进行连接，才做到浏览器与电话进行语音会话
    - 电话挂机，PSIN网联销毁与服务器连接，浏览器关闭

#### 与媒体网关建立

不再采取完全的端到端传输，而是使用媒体网关来终止ice和SRTP，并且将媒体转发给SIP UA，转发时甚至可能采取未加密的RTP形式。不过只有在VoIP网络利用某种其他安全协议时才能如此

媒体网关可以是一个边界元素，称为会话边界控制器(SBC)，用于穿透企业或服务提供的商网络的防火墙

    - 浏览器向web服务器/网关发送请求，服务器响应
    - SIP用户管理向SIP服务器/媒体中继发送REGISTER，SIP服务器响应
    - 浏览器和服务器发送SDP对象 A
    - web服务器向SIP服务器/媒体中继发送Invite，携带浏览器的SDP
    - SIP服务器/媒体中继向SIP用户管理发送Invite，携带浏览器的SDP
    - SIP响应并携带SIP用户管理的SDP，SIP服务器响应到web服务器，web服务器相应到浏览器
    - 浏览器与SIP服务器进行ICE打洞、密钥协商、安全的媒体会话，媒体会话需要SIP服务器发送给SIP用户管理
    - SIP服务器关闭。。。。。