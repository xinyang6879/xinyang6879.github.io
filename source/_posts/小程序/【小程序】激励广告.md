---
title: 【小程序】上传和下载文件
time: 2025-04-19 11:31:43
categories: 小程序
---

## 接入激励广告

[激励视频广告](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/ad/rewarded-video-ad.html)

小程序的激励广告可以使得小程序增加一个收入来源，在小程序管理后台【流量主】-》【广告管理】-》【新建广告位】，可以选择创建激励视频、插屏、视频贴片和原生模板广告，可以设置广告时长（6-15 秒、6-30 秒、6-60 秒、60-不限）

创建完成后，会有个广告 id，这个 id 可以作为前端加载初始化的参数。一个小程序可以有多个广告 id，因此可以用不同的广告 id 来去区分不同场景

### 载入

小程序官方文件推荐在`onLoad`生命周期中加载广告组件

```js
rewardedVideoAdRef = wx.createRewardedVideoAd({ adUnitId: "广告id" });
```

在其加载完成后，如果在未加载完成的情况下，是无法调起广告的

```js
// 监听广告加载事件，加载完成后隐藏加载提示
rewardedVideoAdRef.onLoad(() => {
  resolve("onload");
});
// 监听广告错误事件，隐藏加载提示并打印错误信息
rewardedVideoAdRef.onError((err) => {
  reject("onerror");
});
```

### 展示

广告加载完成会有一段时间，调用`show`到实际展示时也会有一段时间，建议给个 loading

```js
uni.showLoading({ title: "加载中" });
rewardedVideoAdRef
  .show()
  .then(() => {
    // 可以拿到广告的打开时间
    showTime = new Date().getTime();
    uni.hideLoading();
  })
  .catch((err) => {
    uni.hideLoading();
    failCb && failCb(err);
  });
```

### 监听关闭

小程序提供了`onClose`事件，在用户主动点击关闭按钮时触发，即使广告已经结束的情况下，不会主动关闭，需要用户手动操作

其中的`isEnded`标识这次关闭事件是否完整观看，如果完整观看则返回 true，否则返回 false

```js
rewardedVideoAdRef?.onClose((res) => {
  const closeTime = new Date().getTime();
  //   向后端发送广告数据
  if (isAutoUp) {
    reportAdData({
      view_time: showTime,
      finish_time: closeTime,
      finished: res.isEnded,
      id: videoAdData?.id,
    }).then(() => {
      successCb && successCb(res.isEnded);
      resolve(res.isEnded);
    });
  } else {
    successCb && successCb(res.isEnded);
    resolve(res.isEnded);
  }
});
```

### 全部代码

将激励视频相关的全部抽离到一个 hooks 中

```js
/**
 * 钩子函数，用于管理微信激励视频广告的生命周期
 * 包括广告的创建和显示
 * 该函数返回两个函数：createAd用于创建广告，showAd用于显示广告
 */
export const useRewardedVideoAd = (failCb) => {
  // 初始化微信激励视频广告对象为null
  let rewardedVideoAdRef = null;
  // 广告是否加载失败
  let onLoadVideoAdFail = false;
  let showTime = new Date().getTime();

  /**
   * 创建微信激励视频广告的函数
   * 该函数会检查是否存在wx.createRewardedVideoAd方法，如果存在则创建广告
   * 并监听广告的加载、错误和关闭事件
   */
  const onCreateAd = () => {
    return new Promise((resolve, reject) => {
      if (wx.createRewardedVideoAd) {
        let loaded = false;
        let timer = null;
        const maxLoading = 20000;
        // 创建微信激励视频广告实例
        rewardedVideoAdRef = wx.createRewardedVideoAd({ adUnitId: "广告id" });
        // 监听广告加载事件，加载完成后隐藏加载提示
        rewardedVideoAdRef.onLoad(() => {
          uni.hideLoading();
          loaded = true;
          clearTimeout(timer);
          console.trace();
          resolve("onload");
          console.log("rewardedVideoAdRef---onLoad event emit,");
        });
        // 监听广告错误事件，隐藏加载提示并打印错误信息
        rewardedVideoAdRef.onError((err) => {
          uni.hideLoading();
          loaded = true;
          clearTimeout(timer);
          onLoadVideoAdFail = true;
          console.log("rewardedVideoAdRef---onError event emit", err);
          reject("onerror");
        });
        // 这个是为了防止无法进入onload或者onerror的回调
        timer = setTimeout(() => {
          onLoadVideoAdFail = true;
          clearTimeout(timer);
          if (!loaded) {
            reject("onerror");
          }
        }, maxLoading);
      }
    });
  };

  const onCloseAd = (isAutoUp = true, extraParams = {}, successCb) => {
    return new Promise((resolve) => {
      /**
       * 监听广告关闭事件，根据用户是否完整观看视频执行不同逻辑
       * 如果用户完整观看视频，打印相应信息
       * 否则，打印用户未完整观看视频的信息
       */

      rewardedVideoAdRef?.onClose((res) => {
        const closeTime = new Date().getTime();
        console.log("rewardedVideoAdRef---onClose event emit", isAutoUp, res);
        if (isAutoUp) {
          reportAdData({
            view_time: showTime,
            finish_time: closeTime,
            finished: res.isEnded,
            id: "广告id",
            ...extraParams,
          }).then(() => {
            successCb && successCb(res.isEnded);
            resolve(res.isEnded);
          });
        } else {
          successCb && successCb(res.isEnded);
          resolve(res.isEnded);
        }
      });
    });
  };

  /**
   * 显示微信激励视频广告的函数
   * 尝试显示广告，如果显示失败则重新创建并尝试显示
   */
  const onShowAd = () => {
    if (rewardedVideoAdRef) {
      uni.showLoading({ title: "加载中" });
      // 尝试显示广告，如果显示失败则重新创建广告并再次尝试显示
      rewardedVideoAdRef
        .show()
        .then(() => {
          showTime = new Date().getTime();
          uni.hideLoading();
        })
        .catch((err) => {
          console.log("onShowAd---catch", err);
          uni.hideLoading();
          failCb && failCb(err);
        });
    }
  };

  const onLoadAd = () => {
    return new Promise((resolve) => {
      onCreateAd().then((res) => {
        resolve(res);
      });
    });
  };

  // 返回创建和显示广告的函数，供外部调用
  return {
    onCreateAd,
    onShowAd,
    rewardedVideoAdRef,
    onCloseAd,
    onLoadVideoAdFail,
    onLoadAd,
  };
};
```

使用方式：

```js
// 视频关闭回调
const onClose = (isEnab) => {
  if (!isEnab) {
    uni.showToast({
      title: "增加权益失败",
      icon: "none",
    });
  }
  uni.navigateBack();
};

onCreateAd()
  .then(() => {
    onShowAd();
    onCloseAd(true, {}, (isEnab) => {
      onClose(isEnab);
    });
    isShowed = true;
  })
  .catch(() => {
    uni.hideLoading();
    uni.showToast({
      title: "视频获取失败",
      icon: "error",
    });
  });
```
